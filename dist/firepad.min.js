/*!
 * Firepad is an open-source, collaborative code and text editor. It was designed
 * to be embedded inside larger applications. Since it uses Firebase as a backend,
 * it requires no server-side code and can be added to any web app simply by
 * including a couple JavaScript files.
 *
 * Firepad 0.0.0
 * http://www.firepad.io/
 * License: MIT
 * Copyright: 2014 Firebase
 * With code from ot.js (Copyright 2012-2013 Tim Baumann)
 */
!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof c.define&&c.define.amd?define(b):c[a]=b()}("Firepad",function(){function a(a){var b=a.getCursor("head").line,c=a.lineCount(),d=c-1===b;d&&(a.replaceSelection("\n","end","+input"),a.setCursor({line:b-1,ch:0}))}var b=b||{};b.utils={},b.utils.makeEventEmitter=function(a,b){a.prototype.allowedEvents_=b,a.prototype.on=function(a,b,c){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[a]=this.eventListeners_[a]||[],this.eventListeners_[a].push({callback:b,context:c})},a.prototype.off=function(a,b){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{};for(var c=this.eventListeners_[a]||[],d=0;d<c.length;d++)if(c[d].callback===b)return void c.splice(d,1)},a.prototype.trigger=function(a){this.eventListeners_=this.eventListeners_||{};for(var b=this.eventListeners_[a]||[],c=0;c<b.length;c++)b[c].callback.apply(b[c].context,Array.prototype.slice.call(arguments,1))},a.prototype.validateEventType_=function(a){if(this.allowedEvents_){for(var b=!1,c=0;c<this.allowedEvents_.length;c++)if(this.allowedEvents_[c]===a){b=!0;break}if(!b)throw new Error('Unknown event "'+a+'"')}}},b.utils.elt=function(a,c,d){var e=document.createElement(a);if("string"==typeof c)b.utils.setTextContent(e,c);else if(c)for(var f=0;f<c.length;++f)e.appendChild(c[f]);for(var g in d||{})e.setAttribute(g,d[g]);return e},b.utils.setTextContent=function(a,b){a.innerHTML="",a.appendChild(document.createTextNode(b))},b.utils.on=function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d||!1):a.attachEvent&&a.attachEvent("on"+b,c)},b.utils.off=function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,d||!1):a.detachEvent&&a.detachEvent("on"+b,c)},b.utils.preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},b.utils.stopPropagation=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},b.utils.stopEvent=function(a){b.utils.preventDefault(a),b.utils.stopPropagation(a)},b.utils.stopEventAnd=function(a){return function(c){return a(c),b.utils.stopEvent(c),!1}},b.utils.trim=function(a){return a.replace(/^\s+/g,"").replace(/\s+$/g,"")},b.utils.stringEndsWith=function(a,b){for(var c="string"==typeof b?[b]:b,d=0;d<c.length;d++){var b=c[d];if(-1!==a.indexOf(b,a.length-b.length))return!0}return!1},b.utils.assert=function(a,b){if(!a)throw new Error(b||"assertion error")},b.utils.log=function(){if("undefined"!=typeof console&&"undefined"!=typeof console.log){for(var a=["Firepad:"],b=0;b<arguments.length;b++)a.push(arguments[b]);console.log.apply(console,a)}};var b=b||{};b.Span=function(){function a(a,b){this.pos=a,this.length=b}return a.prototype.end=function(){return this.pos+this.length},a}();var b=b||{};b.TextOp=function(){function a(a){this.type=a,this.chars=null,this.text=null,this.attributes=null,"insert"===a?(this.text=arguments[1],c.assert("string"==typeof this.text),this.attributes=arguments[2]||{},c.assert("object"==typeof this.attributes)):"delete"===a?(this.chars=arguments[1],c.assert("number"==typeof this.chars)):"retain"===a&&(this.chars=arguments[1],c.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},c.assert("object"==typeof this.attributes))}var c=b.utils;return a.prototype.isInsert=function(){return"insert"===this.type},a.prototype.isDelete=function(){return"delete"===this.type},a.prototype.isRetain=function(){return"retain"===this.type},a.prototype.equals=function(a){return this.type===a.type&&this.text===a.text&&this.chars===a.chars&&this.attributesEqual(a.attributes)},a.prototype.attributesEqual=function(a){for(var b in this.attributes)if(this.attributes[b]!==a[b])return!1;for(b in a)if(this.attributes[b]!==a[b])return!1;return!0},a.prototype.hasEmptyAttributes=function(){var a=!0;for(var b in this.attributes){a=!1;break}return a},a}();var b=b||{};b.TextOperation=function(){"use strict";function a(){return this&&this.constructor===a?(this.ops=[],this.baseLength=0,void(this.targetLength=0)):new a}function c(a){var b=a.ops;switch(b.length){case 1:return b[0];case 2:return b[0].isRetain()?b[1]:b[1].isRetain()?b[0]:null;case 3:if(b[0].isRetain()&&b[2].isRetain())return b[1]}return null}function d(a){return a.ops[0].isRetain()?a.ops[0].chars:0}var e=b.TextOp,f=b.utils;return a.prototype.equals=function(a){if(this.baseLength!==a.baseLength)return!1;if(this.targetLength!==a.targetLength)return!1;if(this.ops.length!==a.ops.length)return!1;for(var b=0;b<this.ops.length;b++)if(!this.ops[b].equals(a.ops[b]))return!1;return!0},a.prototype.retain=function(a,b){if("number"!=typeof a||0>a)throw new Error("retain expects a positive integer.");if(0===a)return this;this.baseLength+=a,this.targetLength+=a,b=b||{};var c=this.ops.length>0?this.ops[this.ops.length-1]:null;return c&&c.isRetain()&&c.attributesEqual(b)?c.chars+=a:this.ops.push(new e("retain",a,b)),this},a.prototype.insert=function(a,b){if("string"!=typeof a)throw new Error("insert expects a string");if(""===a)return this;b=b||{},this.targetLength+=a.length;var c=this.ops.length>0?this.ops[this.ops.length-1]:null,d=this.ops.length>1?this.ops[this.ops.length-2]:null;return c&&c.isInsert()&&c.attributesEqual(b)?c.text+=a:c&&c.isDelete()?d&&d.isInsert()&&d.attributesEqual(b)?d.text+=a:(this.ops[this.ops.length-1]=new e("insert",a,b),this.ops.push(c)):this.ops.push(new e("insert",a,b)),this},a.prototype["delete"]=function(a){if("string"==typeof a&&(a=a.length),"number"!=typeof a||0>a)throw new Error("delete expects a positive integer or a string");if(0===a)return this;this.baseLength+=a;var b=this.ops.length>0?this.ops[this.ops.length-1]:null;return b&&b.isDelete()?b.chars+=a:this.ops.push(new e("delete",a)),this},a.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},a.prototype.clone=function(){for(var b=new a,c=0;c<this.ops.length;c++)this.ops[c].isRetain()?b.retain(this.ops[c].chars,this.ops[c].attributes):this.ops[c].isInsert()?b.insert(this.ops[c].text,this.ops[c].attributes):b["delete"](this.ops[c].chars);return b},a.prototype.toString=function(){var a=Array.prototype.map||function(a){for(var b=this,c=[],d=0,e=b.length;e>d;d++)c[d]=a(b[d]);return c};return a.call(this.ops,function(a){return a.isRetain()?"retain "+a.chars:a.isInsert()?"insert '"+a.text+"'":"delete "+a.chars}).join(", ")},a.prototype.toJSON=function(){for(var a=[],b=0;b<this.ops.length;b++)this.ops[b].hasEmptyAttributes()||a.push(this.ops[b].attributes),"retain"===this.ops[b].type?a.push(this.ops[b].chars):"insert"===this.ops[b].type?a.push(this.ops[b].text):"delete"===this.ops[b].type&&a.push(-this.ops[b].chars);return 0===a.length&&a.push(0),a},a.fromJSON=function(b){for(var c=new a,d=0,e=b.length;e>d;d++){var g=b[d],h={};"object"==typeof g&&(h=g,d++,g=b[d]),"number"==typeof g?g>0?c.retain(g,h):c["delete"](-g):(f.assert("string"==typeof g),c.insert(g,h))}return c},a.prototype.apply=function(a,b,c){var d=this;if(b=b||[],c=c||[],a.length!==d.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e,g,h=[],i=0,j=0,k=this.ops,l=0,m=k.length;m>l;l++){var n=k[l];if(n.isRetain()){if(j+n.chars>a.length)throw new Error("Operation can't retain more characters than are left in the string.");for(h[i++]=a.slice(j,j+n.chars),e=0;e<n.chars;e++){var o=b[j+e]||{},p={};for(g in o)p[g]=o[g],f.assert(p[g]!==!1);for(g in n.attributes)n.attributes[g]===!1?delete p[g]:p[g]=n.attributes[g],f.assert(p[g]!==!1);c.push(p)}j+=n.chars}else if(n.isInsert())for(h[i++]=n.text,e=0;e<n.text.length;e++){var q={};for(g in n.attributes)q[g]=n.attributes[g],f.assert(q[g]!==!1);c.push(q)}else j+=n.chars}if(j!==a.length)throw new Error("The operation didn't operate on the whole string.");var r=h.join("");return f.assert(r.length===c.length),r},a.prototype.invert=function(b){for(var c=0,d=new a,e=this.ops,f=0,g=e.length;g>f;f++){var h=e[f];h.isRetain()?(d.retain(h.chars),c+=h.chars):h.isInsert()?d["delete"](h.text.length):(d.insert(b.slice(c,c+h.chars)),c+=h.chars)}return d},a.prototype.compose=function(b){function c(a,b,c){var d,e={};for(d in a)e[d]=a[d];for(d in b)c&&b[d]===!1?delete e[d]:e[d]=b[d];return e}var d=this;if(d.targetLength!==b.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e,f=new a,g=d.clone().ops,h=b.clone().ops,i=0,j=0,k=g[i++],l=h[j++];;){if("undefined"==typeof k&&"undefined"==typeof l)break;if(k&&k.isDelete())f["delete"](k.chars),k=g[i++];else if(l&&l.isInsert())f.insert(l.text,l.attributes),l=h[j++];else{if("undefined"==typeof k)throw new Error("Cannot compose operations: first operation is too short.");if("undefined"==typeof l)throw new Error("Cannot compose operations: first operation is too long.");if(k.isRetain()&&l.isRetain())e=c(k.attributes,l.attributes),k.chars>l.chars?(f.retain(l.chars,e),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f.retain(k.chars,e),k=g[i++],l=h[j++]):(f.retain(k.chars,e),l.chars-=k.chars,k=g[i++]);else if(k.isInsert()&&l.isDelete())k.text.length>l.chars?(k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(k=g[i++],l=h[j++]):(l.chars-=k.text.length,k=g[i++]);else if(k.isInsert()&&l.isRetain())e=c(k.attributes,l.attributes,!0),k.text.length>l.chars?(f.insert(k.text.slice(0,l.chars),e),k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(f.insert(k.text,e),k=g[i++],l=h[j++]):(f.insert(k.text,e),l.chars-=k.text.length,k=g[i++]);else{if(!k.isRetain()||!l.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(k)+", op2: "+JSON.stringify(l));k.chars>l.chars?(f["delete"](l.chars),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f["delete"](l.chars),k=g[i++],l=h[j++]):(f["delete"](k.chars),l.chars-=k.chars,k=g[i++])}}}return f},a.prototype.shouldBeComposedWith=function(a){if(this.isNoop()||a.isNoop())return!0;var b=d(this),e=d(a),f=c(this),g=c(a);return f&&g?f.isInsert()&&g.isInsert()?b+f.text.length===e:f.isDelete()&&g.isDelete()?e+g.chars===b||b===e:!1:!1},a.prototype.shouldBeComposedWithInverted=function(a){if(this.isNoop()||a.isNoop())return!0;var b=d(this),e=d(a),f=c(this),g=c(a);return f&&g?f.isInsert()&&g.isInsert()?b+f.text.length===e||b===e:f.isDelete()&&g.isDelete()?e+g.chars===b:!1:!1},a.transformAttributes=function(a,b){var c,d={},e={},g={};for(c in a)g[c]=!0;for(c in b)g[c]=!0;for(c in g){var h=a[c],i=b[c];f.assert(null!=h||null!=i),null==h?e[c]=i:null==i?d[c]=h:h===i||(d[c]=h)}return[d,e]},a.transform=function(b,c){if(b.baseLength!==c.baseLength)throw new Error("Both operations have to have the same base length");for(var d=new a,e=new a,f=b.clone().ops,g=c.clone().ops,h=0,i=0,j=f[h++],k=g[i++];;){if("undefined"==typeof j&&"undefined"==typeof k)break;if(j&&j.isInsert())d.insert(j.text,j.attributes),e.retain(j.text.length),j=f[h++];else if(k&&k.isInsert())d.retain(k.text.length),e.insert(k.text,k.attributes),k=g[i++];else{if("undefined"==typeof j)throw new Error("Cannot transform operations: first operation is too short.");if("undefined"==typeof k)throw new Error("Cannot transform operations: first operation is too long.");var l;if(j.isRetain()&&k.isRetain()){var m=a.transformAttributes(j.attributes,k.attributes);j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d.retain(l,m[0]),e.retain(l,m[1])}else if(j.isDelete()&&k.isDelete())j.chars>k.chars?(j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(j=f[h++],k=g[i++]):(k.chars-=j.chars,j=f[h++]);else if(j.isDelete()&&k.isRetain())j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d["delete"](l);else{if(!j.isRetain()||!k.isDelete())throw new Error("The two operations aren't compatible");j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=j.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),e["delete"](l)}}}return[d,e]},a.prototype.transform=function(b){return a.transform(this,b)},a}();var b=b||{};b.AnnotationList=function(){function a(a,b){if(!a)throw new Error("AnnotationList assertion failed"+(b?": "+b:""))}function c(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.attachedObject_=b.attachedObject}function d(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.node_=b}function e(a){this.head_=new f(0,h),this.changeHandler_=a}function f(a,b){this.length=a,this.annotation=b,this.attachedObject=null,this.next=null}var g=b.Span;c.prototype.getAttachedObject=function(){return this.attachedObject_},d.prototype.attachObject=function(a){this.node_.attachedObject=a};var h={equals:function(){return!1}};return e.prototype.insertAnnotatedSpan=function(b,c){this.wrapOperation_(new g(b.pos,0),function(d,e){a(!e||null===e.next);var g=new f(b.length,c);if(e){a(b.pos>d&&b.pos<d+e.length);var i=new f(0,h);return i.next=new f(b.pos-d,e.annotation),i.next.next=g,g.next=new f(d+e.length-b.pos,e.annotation),i.next}return g})},e.prototype.removeSpan=function(b){0!==b.length&&this.wrapOperation_(b,function(c,d){a(null!==d);var e=new f(0,h),g=e;for(b.pos>c&&(g.next=new f(b.pos-c,d.annotation),g=g.next);b.end()>c+d.length;)c+=d.length,d=d.next;var i=c+d.length-b.end();return i>0&&(g.next=new f(i,d.annotation)),e.next})},e.prototype.updateSpan=function(b,c){0!==b.length&&this.wrapOperation_(b,function(d,e){a(null!==e);var g=new f(0,h),i=g,j=d,k=b.pos-j;for(a(k<e.length),k>0&&(i.next=new f(k,e.annotation),i=i.next,j+=i.length);null!==e&&b.end()>=d+e.length;){var l=d+e.length-j;i.next=new f(l,c(e.annotation,l)),i=i.next,d+=e.length,e=e.next,j=d}var m=b.end()-j;return m>0&&(a(m<e.length),i.next=new f(m,c(e.annotation,m)),i=i.next,j+=i.length,i.next=new f(d+e.length-j,e.annotation)),g.next})},e.prototype.wrapOperation_=function(a,b){if(a.pos<0)throw new Error("Span start cannot be negative.");var e,g=[],h=[],i=this.getAffectedNodes_(a);null!==i.start?(e=i.end.next,i.end.next=null):e=i.succ;var j=b(i.startPos,i.start),k=!1,l=!1;if(j){this.mergeNodesWithSameAnnotations_(j);var m;for(i.pred&&i.pred.annotation.equals(j.annotation)?(k=!0,j.length+=i.pred.length,i.beforePred.next=j,m=i.predPos):(i.beforeStart.next=j,m=i.startPos);j.next;)h.push(new d(m,j)),m+=j.length,j=j.next;i.succ&&i.succ.annotation.equals(j.annotation)?(j.length+=i.succ.length,l=!0,j.next=i.succ.next):j.next=e,h.push(new d(m,j))}else i.pred&&i.succ&&i.pred.annotation.equals(i.succ.annotation)?(k=!0,l=!0,j=new f(i.pred.length+i.succ.length,i.pred.annotation),i.beforePred.next=j,j.next=i.succ.next,h.push(new d(i.startPos-i.pred.length,j))):i.beforeStart.next=e;k&&g.push(new c(i.predPos,i.pred));for(var n=i.startPos,o=i.start;null!==o;)g.push(new c(n,o)),n+=o.length,o=o.next;l&&g.push(new c(n,i.succ)),this.changeHandler_(g,h)},e.prototype.getAffectedNodes_=function(a){for(var b={},c=null,d=this.head_,e=d.next,f=0;null!==e&&a.pos>=f+e.length;)f+=e.length,c=d,d=e,e=e.next;if(null===e&&(0!==a.length||a.pos!==f))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(b.startPos=f,0===a.length&&a.pos===f?b.start=null:b.start=e,b.beforeStart=d,f===a.pos&&f>0?(b.pred=d,b.predPos=f-d.length,b.beforePred=c):b.pred=null;null!==e&&a.end()>f;)f+=e.length,d=e,e=e.next;if(a.end()>f)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===a.length&&a.end()===f?b.end=null:b.end=d,b.succ=f===a.end()?e:null,b},e.prototype.mergeNodesWithSameAnnotations_=function(a){if(a)for(var b=null,c=a;c;)b&&b.annotation.equals(c.annotation)?(b.length+=c.length,b.next=c.next):b=c,c=c.next},e.prototype.forEach=function(a){for(var b=this.head_.next;null!==b;)a(b.length,b.annotation,b.attachedObject),b=b.next},e.prototype.getAnnotatedSpansForPos=function(a){for(var b=0,d=this.head_.next,e=null;null!==d&&b+d.length<=a;)b+=d.length,e=d,d=d.next;if(null===d&&b!==a)throw new Error("pos exceeds the bounds of the AnnotationList");var f=[];return b===a&&e&&f.push(new c(b-e.length,e)),d&&f.push(new c(b,d)),f},e.prototype.getAnnotatedSpansForSpan=function(a){if(0===a.length)return[];for(var b=[],c=this.getAffectedNodes_(a),d=c.startPos,e=c.start;null!==e&&d<a.end();){var f=Math.max(d,a.pos),h=Math.min(d+e.length,a.end()),i=new g(f,h-f);i.annotation=e.annotation,b.push(i),d+=e.length,e=e.next}return b},e.prototype.count=function(){for(var b=0,c=this.head_.next,d=null;null!==c;)d&&a(!d.annotation.equals(c.annotation)),d=c,c=c.next,b++;return b},f.prototype.clone=function(){var a=new f(this.spanLength,this.annotation);return a.next=this.next,a},e}();var b=b||{};b.Cursor=function(){"use strict";function a(a,b){this.position=a,this.selectionEnd=b}return a.fromJSON=function(b){return new a(b.position,b.selectionEnd)},a.prototype.equals=function(a){return this.position===a.position&&this.selectionEnd===a.selectionEnd},a.prototype.compose=function(a){return a},a.prototype.transform=function(b){function c(a){for(var c=a,d=b.ops,e=0,f=b.ops.length;f>e&&(d[e].isRetain()?a-=d[e].chars:d[e].isInsert()?c+=d[e].text.length:(c-=Math.min(a,d[e].chars),a-=d[e].chars),!(0>a));e++);return c}var d=c(this.position);return this.position===this.selectionEnd?new a(d,d):new a(d,c(this.selectionEnd))},a}();var b=b||{};b.FirebaseAdapter=function(a){function c(a,b,c){this.ref_=a,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new g,this.revision_=0,this.pendingReceivedRevisions_={};var d=this;if(b){this.setUserId(b),this.setColor(c);var e=a.root.child(".info/connected");this.firebaseOn_(e,"value",function(a){a.val()===!0&&d.initializeUserData_()},this),this.on("ready",function(){d.monitorCursors_()})}else this.userId_=a.push().key;setTimeout(function(){d.monitorHistory_()},0)}function d(a,b){if(!a)throw new Error(b||"assertion error")}function e(a){if(0===a)return"A0";for(var b="";a>0;){var c=a%j.length;b=j[c]+b,a-=c,a/=j.length}var d=j[b.length+9];return d+b}function f(a){d(a.length>0&&a[0]===j[a.length+8]);for(var b=0,c=1;c<a.length;c++)b*=j.length,b+=j.indexOf(a[c]);return b}"undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase;var g=b.TextOperation,h=b.utils,i=100;h.makeEventEmitter(c,["ready","cursor","operation","ack","retry"]),c.prototype.dispose=function(){var a=this;return this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove()),this.ref_=null,this.document_=null,void(this.zombie_=!0)):void this.on("ready",function(){a.dispose()})},c.prototype.setUserId=function(a){var b=this;b.userRef_&&(b.userRef_.child("cursor").remove(),b.userRef_.child("cursor").onDisconnect().cancel(),b.userRef_.child("color").remove(),b.userRef_.child("color").onDisconnect().cancel()),b.userId_=a,b.lastViewedRevision_=-1,b.userRef_=b.ref_.child("users").child(a),b.userRef_.child("revision").once("value",function(a){a&&a.val()&&(b.lastViewedRevision_=f(a.val().toString()))}),b.initializeUserData_()},c.prototype.isHistoryEmpty=function(){return d(this.ready_,"Not ready yet."),0===this.revision_},c.prototype.sendOperation=function(a,b){function c(a,d){f.ref_.child("history").child(a).transaction(function(a){return null===a?d:void 0},function(e,g,i){if(e){if("disconnect"!==e.message)throw h.log("Transaction failure!",e),e;f.sent_&&f.sent_.id===a?setTimeout(function(){c(a,d)},0):b&&b(e,!1)}else b&&b(null,g)},!1)}var f=this;if(!this.ready_)return void this.on("ready",function(){f.trigger("retry")});d(this.document_.targetLength===a.baseLength,"sendOperation() called with invalid operation.");var g=e(this.revision_);this.sent_={id:g,op:a},c(g,{a:f.userId_,o:a.toJSON(),t:(new Date).getTime()})},c.prototype.sendCursor=function(a){this.userRef_.child("cursor").set(a),this.cursor_=a},c.prototype.setColor=function(a){this.userRef_.child("color").set(a),this.color_=a},c.prototype.getDocument=function(){return this.document_},c.prototype.setLastViewedReview=function(a){var b=this;setTimeout(function(){b.userRef_.child("revision").set(a),b.lastViewedRevision_=f(a)},0)},c.prototype.registerCallbacks=function(a){for(var b in a)this.on(b,a[b])},c.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},c.prototype.monitorCursors_=function(){function a(a){var b=a.key,d=a.val();c.trigger("cursor",b,d.cursor,d.color)}var b=this.ref_.child("users"),c=this;this.firebaseOn_(b,"child_added",a),this.firebaseOn_(b,"child_changed",a),this.firebaseOn_(b,"child_removed",function(a){var b=a.key;c.trigger("cursor",b,null)})},c.prototype.monitorHistory_=function(){var a=this;this.ref_.child("checkpoint").once("value",function(b){if(!a.zombie_){var c=b.child("id").val(),d=b.child("o").val(),e=b.child("a").val();null!=d&&null!=c&&null!==e?(a.pendingReceivedRevisions_[c]={o:d,a:e},a.checkpointRevision_=f(c),a.monitorHistoryStartingAt_(a.checkpointRevision_+1)):(a.checkpointRevision_=0,a.monitorHistoryStartingAt_(a.checkpointRevision_))}})},c.prototype.monitorHistoryStartingAt_=function(a){var b=this.ref_.child("history").startAt(null,e(a)),c=this;setTimeout(function(){c.firebaseOn_(b,"child_added",function(a){var b=a.key;c.pendingReceivedRevisions_[b]=a.val(),c.ready_&&c.handlePendingReceivedRevisions_()}),b.once("value",function(){c.handleInitialRevisions_()})},0)},c.prototype.handleInitialRevisions_=function(){d(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;var a,b=e(this.revision_),c=this.pendingReceivedRevisions_;if(c&&Object.keys(c).length){const f=Object.keys(c);a=f[f.length-1]}for(;null!=c[b];){var g=this.parseRevision_(c,b);g?this.document_=this.document_.compose(g.operation):h.log("Invalid operation.",this.ref_.toString(),b,c[b]),delete c[b],this.revision_++,b=e(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var i=this;setTimeout(function(){i.trigger("ready")},0),a&&this.setLastViewedReview(a)},c.prototype.handlePendingReceivedRevisions_=function(){var a,b=this.pendingReceivedRevisions_,c=e(this.revision_),d=!1;if(b&&Object.keys(b).length){const f=Object.keys(b);a=f[f.length-1],this.setLastViewedReview(a)}for(;null!=b[c];){this.revision_++;var g=this.parseRevision_(b,c);g?(this.document_=this.document_.compose(g.operation),this.sent_&&c===this.sent_.id?this.sent_.op.equals(g.operation)&&g.author===this.userId_?(this.revision_%i===0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(d=!0,this.trigger("operation",g.operation)):this.trigger("operation",g.operation)):h.log("Invalid operation.",this.ref_.toString(),c,b[c]),delete b[c],c=e(this.revision_)}d&&(this.sent_=null,this.trigger("retry"))},c.prototype.parseRevision_=function(a,b){var c=a[b];if("object"!=typeof c)return null;if("string"!=typeof c.a||"object"!=typeof c.o)return null;c=this.markOperationAsRead(c,b);var d=null;try{d=g.fromJSON(c.o)}catch(e){return null}return d.baseLength!==this.document_.targetLength?null:{author:c.a,operation:d}},c.prototype.getOperationAttributesIndex=function(a){var b=-1;return"object"==typeof a.o&&a.o.length>=2&&a.o.forEach(function(a,c){a.a&&(b=c)}),b},c.prototype.markOperationAsRead=function(a,b){var c=this.getOperationAttributesIndex(a);if(-1===c)return a;var d=a.o[c];return"unread"===d[this.userId_]&&this.lastViewedRevision_+1>=f(b)&&(d[this.userId_]="read",a.o[c]=d),this.ref_.child("history").child(b).child("o").child(c).child(this.userId_).set("read"),a},c.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:e(this.revision_-1)})},c.prototype.firebaseOn_=function(a,b,c,d){return this.firebaseCallbacks_.push({ref:a,eventType:b,callback:c,context:d}),a.on(b,c,d),c},c.prototype.firebaseOff_=function(a,b,c,d){a.off(b,c,d);for(var e=0;e<this.firebaseCallbacks_.length;e++){var f=this.firebaseCallbacks_[e];if(f.ref===a&&f.eventType===b&&f.callback===c&&f.context===d){this.firebaseCallbacks_.splice(e,1);break}}},c.prototype.removeFirebaseCallbacks_=function(){for(var a=0;a<this.firebaseCallbacks_.length;a++){var b=this.firebaseCallbacks_[a];b.ref.off(b.eventType,b.callback,b.context)}this.firebaseCallbacks_=[]};var j="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return c}();var b=b||{};b.RichTextToolbar=function(a){function c(a){this.imageInsertionUI=a,this.element_=this.makeElement_()}var d=b.utils;return d.makeEventEmitter(c,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),c.prototype.element=function(){return this.element_},c.prototype.makeButton_=function(a,b){var c=this;b=b||a;var e=d.elt("a",[d.elt("span","",{"class":"firepad-tb-"+b})],{"class":"waves-effect waves-light btn"});return d.on(e,"click",d.stopEventAnd(function(){c.trigger(a)})),e},c.prototype.makeElement_=function(){var a=this,b=(this.makeFontDropdown_(),this.makeFontSizeDropdown_(),this.makeColorDropdown_(),[d.elt("div",[a.makeButton_("bold"),a.makeButton_("italic"),a.makeButton_("underline"),a.makeButton_("strike","strikethrough")],{"class":"firepad-btn-group"}),d.elt("div",[a.makeButton_("unordered-list","list-2"),a.makeButton_("ordered-list","numbered-list"),a.makeButton_("todo-list","list")],{"class":"firepad-btn-group"}),d.elt("div",[a.makeButton_("indent-decrease"),a.makeButton_("indent-increase")],{"class":"firepad-btn-group"}),d.elt("div",[a.makeButton_("left","paragraph-left"),a.makeButton_("center","paragraph-center"),a.makeButton_("right","paragraph-right")],{"class":"firepad-btn-group"}),d.elt("div",[a.makeButton_("undo"),a.makeButton_("redo")],{"class":"firepad-btn-group"})]);a.imageInsertionUI&&b.push(d.elt("div",[a.makeButton_("insert-image")],{"class":"firepad-btn-group"}));var c=d.elt("div",b,{"class":"firepad-toolbar-wrapper"}),e=d.elt("div",null,{"class":"firepad-toolbar"});return e.appendChild(c),e},c.prototype.makeFontDropdown_=function(){for(var a=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],b=[],c=0;c<a.length;c++){var e=d.elt("span",a[c]);e.setAttribute("style","font-family:"+a[c]),b.push({content:e,value:a[c]})}return this.makeDropdown_("Font","font",b)},c.prototype.makeFontSizeDropdown_=function(){for(var a=[9,10,12,14,18,24,32,42],b=[],c=0;c<a.length;c++){var e=d.elt("span",a[c].toString());e.setAttribute("style","font-size:"+a[c]+"px; line-height:"+(a[c]-6)+"px;"),b.push({content:e,value:a[c]})}return this.makeDropdown_("Size","font-size",b,"px")},c.prototype.makeColorDropdown_=function(){for(var a=["black","red","green","blue","yellow","cyan","magenta","grey"],b=[],c=0;c<a.length;c++){var e=d.elt("div");e.className="firepad-color-dropdown-item",e.setAttribute("style","background-color:"+a[c]),b.push({content:e,value:a[c]})}return this.makeDropdown_("Color","color",b)},c.prototype.makeDropdown_=function(a,b,c,e){function f(){l||(k.style.display="block",d.on(document,"click",g,!0),l=!0)}function g(){l&&(k.style.display="",d.off(document,"click",g,!0),l=!1),m=!0,setTimeout(function(){m=!1},0)}function h(a,c){"object"!=typeof a&&(a=document.createTextNode(String(a)));var f=d.elt("a",[a]);d.on(f,"click",d.stopEventAnd(function(){g(),i.trigger(b,c+e)})),k.appendChild(f)}e=e||"";var i=this,j=d.elt("a",a+" ▾",{"class":"firepad-btn firepad-dropdown"}),k=d.elt("ul",[],{"class":"firepad-dropdown-menu"});j.appendChild(k);for(var l=!1,m=!1,n=0;n<c.length;n++){var o=c[n].content,p=c[n].value;h(o,p)}return d.on(j,"click",d.stopEventAnd(function(){m||f()})),j},c}();var b=b||{};b.WrappedOperation=function(a){"use strict";function b(a,b){this.wrapped=a,this.meta=b}function c(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])}function d(a,b){if(a&&"object"==typeof a){if("function"==typeof a.compose)return a.compose(b);var d={};return c(a,d),c(b,d),d}return b}function e(a,b){return a&&"object"==typeof a&&"function"==typeof a.transform?a.transform(b):a}return b.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},b.prototype.invert=function(){var a=this.meta;return new b(this.wrapped.invert.apply(this.wrapped,arguments),a&&"object"==typeof a&&"function"==typeof a.invert?a.invert.apply(a,arguments):a)},b.prototype.compose=function(a){return new b(this.wrapped.compose(a.wrapped),d(this.meta,a.meta))},b.transform=function(a,c){var d=a.wrapped.transform(c.wrapped);return[new b(d[0],e(a.meta,c.wrapped)),new b(d[1],e(c.meta,a.wrapped))]},b.prototype.transform=function(a){return b.transform(this,a)},b}();var b=b||{};b.UndoManager=function(){"use strict";function a(a){this.maxItems=a||50,this.state=c,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function b(a,b){for(var c=[],d=b.constructor,e=a.length-1;e>=0;e--){var f=d.transform(a[e],b);"function"==typeof f[0].isNoop&&f[0].isNoop()||c.push(f[0]),b=f[1]}return c.reverse()}var c="normal",d="undoing",e="redoing";return a.prototype.add=function(a,b){if(this.state===d)this.redoStack.push(a),this.dontCompose=!0;else if(this.state===e)this.undoStack.push(a),this.dontCompose=!0;else{var c=this.undoStack;!this.dontCompose&&b&&c.length>0?c.push(a.compose(c.pop())):(c.push(a),c.length>this.maxItems&&c.shift()),this.dontCompose=!1,this.redoStack=[]}},a.prototype.transform=function(a){this.undoStack=b(this.undoStack,a),this.redoStack=b(this.redoStack,a)},a.prototype.performUndo=function(a){if(this.state=d,0===this.undoStack.length)throw new Error("undo not possible");a(this.undoStack.pop()),this.state=c},a.prototype.performRedo=function(a){if(this.state=e,0===this.redoStack.length)throw new Error("redo not possible");a(this.redoStack.pop()),this.state=c},a.prototype.canUndo=function(){return 0!==this.undoStack.length},a.prototype.canRedo=function(){return 0!==this.redoStack.length},a.prototype.isUndoing=function(){return this.state===d},a.prototype.isRedoing=function(){return this.state===e},a}();var b=b||{};b.Client=function(){"use strict";function a(){this.state=e}function b(){}function c(a){this.outstanding=a}function d(a,b){this.outstanding=a,this.buffer=b}a.prototype.setState=function(a){this.state=a},a.prototype.applyClient=function(a){this.setState(this.state.applyClient(this,a))},a.prototype.applyServer=function(a){this.setState(this.state.applyServer(this,a))},a.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},a.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},a.prototype.sendOperation=function(a){throw new Error("sendOperation must be defined in child class")},a.prototype.applyOperation=function(a){throw new Error("applyOperation must be defined in child class")},a.Synchronized=b,b.prototype.applyClient=function(a,b){return a.sendOperation(b),new c(b)},b.prototype.applyServer=function(a,b){return a.applyOperation(b),this},b.prototype.serverAck=function(a){throw new Error("There is no pending operation.")},b.prototype.serverRetry=function(a){throw new Error("There is no pending operation.")};var e=new b;return a.AwaitingConfirm=c,c.prototype.applyClient=function(a,b){return new d(this.outstanding,b)},c.prototype.applyServer=function(a,b){var d=this.outstanding.transform(b);return a.applyOperation(d[1]),new c(d[0])},c.prototype.serverAck=function(a){return e},c.prototype.serverRetry=function(a){return a.sendOperation(this.outstanding),this},a.AwaitingWithBuffer=d,d.prototype.applyClient=function(a,b){var c=this.buffer.compose(b);return new d(this.outstanding,c)},d.prototype.applyServer=function(a,b){var c=this.outstanding.transform(b),e=this.buffer.transform(c[1]);return a.applyOperation(e[1]),new d(c[0],e[0])},d.prototype.serverRetry=function(a){var b=this.outstanding.compose(this.buffer);return a.sendOperation(b),new c(b)},d.prototype.serverAck=function(a){return a.sendOperation(this.buffer),new c(this.buffer)},a}();var b=b||{};b.EditorClient=function(){
"use strict";function a(a,b){this.cursorBefore=a,this.cursorAfter=b}function c(a,b){this.id=a,this.editorAdapter=b}function d(a,b){g.call(this),this.serverAdapter=a,this.editorAdapter=b,this.undoManager=new i,this.clients={};var c=this;this.editorAdapter.registerCallbacks({change:function(a,b){c.onChange(a,b)},cursorActivity:function(){c.onCursorActivity()},blur:function(){c.onBlur()},focus:function(){c.onFocus()}}),this.editorAdapter.registerUndo(function(){c.undo()}),this.editorAdapter.registerRedo(function(){c.redo()}),this.serverAdapter.registerCallbacks({ack:function(){c.serverAck(),c.focused&&c.state instanceof g.Synchronized&&(c.updateCursor(),c.sendCursor(c.cursor)),c.emitStatus()},retry:function(){c.serverRetry()},operation:function(a){c.applyServer(a)},cursor:function(a,b,d){if(c.serverAdapter.userId_!==a&&c.state instanceof g.Synchronized){var e=c.getClientObject(a);b?(d&&e.setColor(d),e.updateCursor(h.fromJSON(b))):e.removeCursor()}}})}function e(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}function f(a){return a[a.length-1]}var g=b.Client,h=b.Cursor,i=b.UndoManager,j=b.WrappedOperation;return a.prototype.invert=function(){return new a(this.cursorAfter,this.cursorBefore)},a.prototype.compose=function(b){return new a(this.cursorBefore,b.cursorAfter)},a.prototype.transform=function(b){return new a(this.cursorBefore?this.cursorBefore.transform(b):null,this.cursorAfter?this.cursorAfter.transform(b):null)},c.prototype.setColor=function(a){this.color=a},c.prototype.updateCursor=function(a){this.removeCursor(),this.cursor=a,this.mark=this.editorAdapter.setOtherCursor(a,this.color,this.id)},c.prototype.removeCursor=function(){this.mark&&this.mark.clear()},e(d,g),d.prototype.getClientObject=function(a){var b=this.clients[a];return b?b:this.clients[a]=new c(a,this.editorAdapter)},d.prototype.applyUnredo=function(a){this.undoManager.add(this.editorAdapter.invertOperation(a)),this.editorAdapter.applyOperation(a.wrapped),this.cursor=a.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(a.wrapped)},d.prototype.undo=function(){var a=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(b){a.applyUnredo(b)})},d.prototype.redo=function(){var a=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(b){a.applyUnredo(b)})},d.prototype.onChange=function(b,c){var d=this.cursor;this.updateCursor();var e=this.undoManager.undoStack.length>0&&c.shouldBeComposedWithInverted(f(this.undoManager.undoStack).wrapped),g=new a(this.cursor,d);this.undoManager.add(new j(c,g),e),this.applyClient(b)},d.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},d.prototype.onCursorActivity=function(){var a=this.cursor;this.updateCursor(),!this.focused||a&&this.cursor.equals(a)||this.sendCursor(this.cursor)},d.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},d.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},d.prototype.sendCursor=function(a){this.state instanceof g.AwaitingWithBuffer||this.serverAdapter.sendCursor(a)},d.prototype.sendOperation=function(a){this.serverAdapter.sendOperation(a),this.emitStatus()},d.prototype.applyOperation=function(a){this.editorAdapter.applyOperation(a),this.updateCursor(),this.undoManager.transform(new j(a,null))},d.prototype.emitStatus=function(){var a=this;setTimeout(function(){a.trigger("synced",a.state instanceof g.Synchronized)},0)},d}(),b.utils.makeEventEmitter(b.EditorClient,["synced"]);var b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].slice;("undefined"==typeof b||null===b)&&(b={}),b.ACEAdapter=function(){function a(a){this.onCursorActivity=c(this.onCursorActivity,this),this.onFocus=c(this.onFocus,this),this.onBlur=c(this.onBlur,this),this.onChange=c(this.onChange,this);var b;this.ace=a,this.aceSession=this.ace.getSession(),this.aceDoc=this.aceSession.getDocument(),this.aceDoc.setNewLineMode("unix"),this.grabDocumentState(),this.ace.on("change",this.onChange),this.ace.on("blur",this.onBlur),this.ace.on("focus",this.onFocus),this.aceSession.selection.on("changeCursor",this.onCursorActivity),null==this.aceRange&&(this.aceRange=(null!=(b=ace.require)?b:require)("ace/range").Range)}return a.prototype.ignoreChanges=!1,a.prototype.grabDocumentState=function(){return this.lastDocLines=this.aceDoc.getAllLines(),this.lastCursorRange=this.aceSession.selection.getRange()},a.prototype.detach=function(){return this.ace.removeListener("change",this.onChange),this.ace.removeListener("blur",this.onBlur),this.ace.removeListener("focus",this.onFocus),this.aceSession.selection.removeListener("changeCursor",this.onCursorActivity)},a.prototype.onChange=function(a){var b;return this.ignoreChanges?void 0:(b=this.operationFromACEChange(a),this.trigger.apply(this,["change"].concat(d.call(b))),this.grabDocumentState())},a.prototype.onBlur=function(){return this.ace.selection.isEmpty()?this.trigger("blur"):void 0},a.prototype.onFocus=function(){return this.trigger("focus")},a.prototype.onCursorActivity=function(){var a=this;return setTimeout(function(){return a.trigger("cursorActivity")},0)},a.prototype.operationFromACEChange=function(a){var c,d,e,f,g,h,i,j;return a.data?(e=a.data,"insertLines"===(j=e.action)||"removeLines"===j?(i=e.lines.join("\n")+"\n",c=e.action.replace("Lines","")):(i=e.text.replace(this.aceDoc.getNewLineCharacter(),"\n"),c=e.action.replace("Text","")),h=this.indexFromPos(e.range.start)):(i=a.lines.join("\n"),h=this.indexFromPos(a.start)),g=this.lastDocLines.join("\n").length-h,"remove"===a.action&&(g-=i.length),f=(new b.TextOperation).retain(h).insert(i).retain(g),d=(new b.TextOperation).retain(h)["delete"](i).retain(g),"remove"===a.action?[d,f]:[f,d]},a.prototype.applyOperationToACE=function(a){var b,c,d,e,f,g,h,i;for(c=0,i=a.ops,g=0,h=i.length;h>g;g++)d=i[g],d.isRetain()?c+=d.chars:d.isInsert()?(this.aceDoc.insert(this.posFromIndex(c),d.text),c+=d.text.length):d.isDelete()&&(b=this.posFromIndex(c),f=this.posFromIndex(c+d.chars),e=this.aceRange.fromPoints(b,f),this.aceDoc.remove(e));return this.grabDocumentState()},a.prototype.posFromIndex=function(a){var b,c,d,e,f;for(f=this.aceDoc.$lines,c=d=0,e=f.length;e>d&&(b=f[c],!(a<=b.length));c=++d)a-=b.length+1;return{row:c,column:a}},a.prototype.indexFromPos=function(a,b){var c,d,e,f;for(null==b&&(b=this.lastDocLines),d=0,c=e=0,f=a.row;f>=0?f>e:e>f;c=f>=0?++e:--e)d+=this.lastDocLines[c].length+1;return d+=a.column},a.prototype.getValue=function(){return this.aceDoc.getValue()},a.prototype.getCursor=function(){var a,c,d,e,f,g;try{e=this.indexFromPos(this.aceSession.selection.getRange().start,this.aceDoc.$lines),d=this.indexFromPos(this.aceSession.selection.getRange().end,this.aceDoc.$lines)}catch(h){a=h;try{e=this.indexFromPos(this.lastCursorRange.start),d=this.indexFromPos(this.lastCursorRange.end)}catch(h){c=h,console.log("Couldn't figure out the cursor range:",c,"-- setting it to 0:0."),f=[0,0],e=f[0],d=f[1]}}return e>d&&(g=[d,e],e=g[0],d=g[1]),new b.Cursor(e,d)},a.prototype.setCursor=function(a){var b,c,d;return c=this.posFromIndex(a.position),b=this.posFromIndex(a.selectionEnd),a.position>a.selectionEnd&&(d=[b,c],c=d[0],b=d[1]),this.aceSession.selection.setSelectionRange(new this.aceRange(c.row,c.column,b.row,b.column))},a.prototype.setOtherCursor=function(a,b,c){var d,e,f,g,h,i,j,k,l=this;return null==this.otherCursors&&(this.otherCursors={}),f=this.otherCursors[c],f&&(f.start.detach(),f.end.detach(),this.aceSession.removeMarker(f.id)),j=this.posFromIndex(a.position),g=this.posFromIndex(a.selectionEnd),a.selectionEnd<a.position&&(k=[g,j],j=k[0],g=k[1]),d="other-client-selection-"+b.replace("#",""),h=a.position===a.selectionEnd,h&&(d=d.replace("selection","cursor")),e="."+d+" {\n  position: absolute;\n  background-color: "+(h?"transparent":b)+";\n  border-left: 2px solid "+b+";\n}",this.addStyleRule(e),this.otherCursors[c]=f=new this.aceRange(j.row,j.column,g.row,g.column),i=this,f.clipRows=function(){var a;return a=i.aceRange.prototype.clipRows.apply(this,arguments),a.isEmpty=function(){return!1},a},f.start=this.aceDoc.createAnchor(f.start),f.end=this.aceDoc.createAnchor(f.end),f.id=this.aceSession.addMarker(f,d,"text"),{clear:function(){return f.start.detach(),f.end.detach(),l.aceSession.removeMarker(f.id)}}},a.prototype.addStyleRule=function(a){var b;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},b=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(b),this.addedStyleSheet=b.sheet),!this.addedStyleRules[a]))return this.addedStyleRules[a]=!0,this.addedStyleSheet.insertRule(a,0)},a.prototype.registerCallbacks=function(a){this.callbacks=a},a.prototype.trigger=function(){var a,b,c,e;return b=arguments[0],a=2<=arguments.length?d.call(arguments,1):[],null!=(c=this.callbacks)&&null!=(e=c[b])?e.apply(this,a):void 0},a.prototype.applyOperation=function(a){return a.isNoop()||(this.ignoreChanges=!0),this.applyOperationToACE(a),this.ignoreChanges=!1},a.prototype.registerUndo=function(a){return this.ace.undo=a},a.prototype.registerRedo=function(a){return this.ace.redo=a},a.prototype.invertOperation=function(a){return a.invert(this.getValue())},a}(),b.MonacoAdapter=function(){function a(a){this.onCursorActivity=c(this.onCursorActivity,this),this.onFocus=c(this.onFocus,this),this.onBlur=c(this.onBlur,this),this.onChange=c(this.onChange,this),this.monaco=a,this.monacoModel=this.monaco.getModel(),this.grabDocumentState();var b=this.monaco.onDidChangeModelContent(this.onChange),d=this.monaco.onDidBlurEditor(this.onBlur),e=this.monaco.onDidFocusEditor(this.onFocus),f=this.monaco.onDidChangeCursorPosition(this.onCursorActivity);this.detach=function(){b.dispose(),d.dispose(),e.dispose(),f.dispose()}}return a.prototype.ignoreChanges=!1,a.prototype.grabDocumentState=function(){this.lastDocLines=this.monacoModel.getLinesContent();var a=this.monaco.getSelection();return this.lastCursorRange=a},a.prototype.onChange=function(a){var b;return this.ignoreChanges?void 0:(b=this.operationFromMonacoChange(a),this.trigger.apply(this,["change"].concat(d.call(b))),this.grabDocumentState())},a.prototype.onBlur=function(){return this.monaco.getSelection().isEmpty()?this.trigger("blur"):void 0},a.prototype.onFocus=function(){return this.trigger("focus")},a.prototype.onCursorActivity=function(){var a=this;return setTimeout(function(){return a.trigger("cursorActivity")},0)},a.prototype.operationFromMonacoChange=function(a){return text=a.changes[0].text,start=this.indexFromPos(a.changes[0].range,"start"),restLength=this.lastDocLines.join(this.monacoModel.getEOL()).length-start,text_ins=a.changes[0].text,rangeLen=a.changes[0].rangeLength,a.changes[0].rangeLength>0&&(restLength-=rangeLen,text=this.lastDocLines.join(this.monacoModel.getEOL()).slice(start,start+rangeLen)),insert_op=(new b.TextOperation).retain(start).insert(text).retain(restLength),delete_op=(new b.TextOperation).retain(start)["delete"](text).retain(restLength),ins_op_ne=(new b.TextOperation).retain(start)["delete"](text_ins).insert(text).retain(restLength),del_op_ne=(new b.TextOperation).retain(start)["delete"](text).insert(text_ins).retain(restLength),""===a.changes[0].text&&rangeLen>0?[delete_op,insert_op]:""!==a.changes[0].text&&rangeLen>0?[del_op_ne,ins_op_ne]:[insert_op,delete_op]},a.prototype.applyOperationToMonaco=function(a){var b,c,d,e,f,g,h,i,j,k;for(c=0,h=a.ops,f=0,g=h.length;g>f;f++)d=h[f],d.isRetain()?c+=d.chars:d.isInsert()?(k=new monaco.Range(this.posFromIndex(c).row,this.posFromIndex(c).column,this.posFromIndex(c).row,this.posFromIndex(c).column),i={major:1,minor:1},j={identifier:i,range:k,text:d.text,forceMoveMarkers:!0},this.monaco.executeEdits("my-source",[j]),c+=d.text.length):d.isDelete()&&(content=this.monacoModel.getLinesContent(),b=this.posFromIndex(c,content),e=this.posFromIndex(c+d.chars,content),k=new monaco.Range(b.row,b.column,e.row,e.column),i={major:1,minor:2},j={identifier:i,range:k,text:"",forceMoveMarkers:!0},this.monaco.executeEdits("my-source",[j]));return this.grabDocumentState()},a.prototype.posFromIndex=function(a,b){var c,d,e,f,g;for(g=null==b?this.lastDocLines:b,d=e=0,f=g.length;f>e&&(c=g[d],!(a<=c.length));d=++e)a-=c.length+this.monacoModel.getEOL().length;return{row:d+1,column:a+1}},a.prototype.indexFromPos=function(a,b,c){var d;if(null==c&&(c=this.lastDocLines),d=0,"start"===b){for(row=1;row<a.startLineNumber;row++)d+=c[row-1].length+this.monacoModel.getEOL().length;return d+a.startColumn-1}for(row=1;row<a.endLineNumber;row++)d+=c[row-1].length+this.monacoModel.getEOL().length;return d+a.endColumn-1},a.prototype.getValue=function(){return this.monacoModel.getValue()},a.prototype.getCursor=function(){var a,c,d,e,f,g;try{selection=this.monaco.getSelection(),e=this.indexFromPos(selection,"start",this.lastDocLines),d=this.indexFromPos(selection,"end",this.lastDocLines)}catch(h){a=h;try{e=this.indexFromPos(this.lastCursorRange,"start"),d=this.indexFromPos(this.lastCursorRange,"end")}catch(h){c=h,console.log("Couldn't figure out the cursor range:",c,"-- setting it to 0:0."),f=[0,0],e=f[0],d=f[1]}}return e>d&&(g=[d,e],e=g[0],d=g[1]),new b.Cursor(e,d)},a.prototype.setCursor=function(a){var b,c,d;return c=this.posFromIndex(a.position),b=this.posFromIndex(a.selectionEnd),a.position>a.selectionEnd&&(d=[b,c],c=d[0],b=d[1]),this.monaco.setSelection(new monaco.Range(c.row,c.column,b.row,b.column))},a.prototype.setOtherCursor=function(a,b,c){return null==this.otherCursors&&(this.otherCursors={},this.otherCursors[c]=[]),this.otherCursors[c]&&(this.otherCursors[c]=this.monaco.deltaDecorations(this.otherCursors[c],[])),start=this.posFromIndex(a.position),end=this.posFromIndex(a.selectionEnd),clazz="other-client-selection-"+b.replace("#",""),start<0||end<0||start>end?void 0:(justCursor=a.position===a.selectionEnd,justCursor&&(clazz=clazz.replace("selection","cursor")),css="."+clazz+" {\n  position: relative;\nbackground-color: "+(justCursor?"transparent":b)+";\nborder-left: 2px solid "+b+";\n}",this.addStyleRule(css),this.otherCursors[c]=this.monaco.deltaDecorations(this.otherCursors[c],[{range:new monaco.Range(start.row,start.column,end.row,end.column),options:{className:clazz}}]),_this=this,{clear:function(){return _this.monaco.deltaDecorations(_this.otherCursors[c],[])}})},a.prototype.addStyleRule=function(a){var b;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},b=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(b),this.addedStyleSheet=b.sheet),!this.addedStyleRules[a]))return this.addedStyleRules[a]=!0,this.addedStyleSheet.insertRule(a,0)},a.prototype.registerCallbacks=function(a){this.callbacks=a},a.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},a.prototype.applyOperation=function(a){return a.isNoop()||(this.ignoreChanges=!0),this.applyOperationToMonaco(a),this.ignoreChanges=!1},a.prototype.registerUndo=function(a){return this.monacoModel.undo=a},a.prototype.registerRedo=function(a){return this.monacoModel.redo=a},a.prototype.invertOperation=function(a){return a.invert(this.getValue())},a}();var b=b||{};b.AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},b.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""};var b=b||{};b.EntityManager=function(){function a(){this.entities_={};var a=["src","alt","width","height","style","class"];this.register("img",{render:function(a){c.assert(a.src,"image entity should have 'src'!");for(var b=["src","alt","width","height","style","class"],d="<img ",e=0;e<b.length;e++){var f=b[e];f in a&&(d+=" "+f+'="'+a[f]+'"')}return d+=">"},fromElement:function(b){for(var c={},d=0;d<a.length;d++){var e=a[d];b.hasAttribute(e)&&(c[e]=b.getAttribute(e))}return c}})}var c=b.utils;return a.prototype.register=function(a,c){b.utils.assert(c.render,"Entity options should include a 'render' function!"),b.utils.assert(c.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[a]=c},a.prototype.renderToElement=function(a,b){return this.tryRenderToElement_(a,"render",b)},a.prototype.exportToElement=function(a){var b=this.tryRenderToElement_(a,"export")||this.tryRenderToElement_(a,"getHtml")||this.tryRenderToElement_(a,"render");return b.setAttribute("data-firepad-entity",a.type),b},a.prototype.updateElement=function(a,b){var c=a.type,d=a.info;this.entities_[c]&&"undefined"!=typeof this.entities_[c].update&&this.entities_[c].update(d,b)},a.prototype.fromElement=function(a){var c=a.getAttribute("data-firepad-entity");if(c||(c=a.nodeName.toLowerCase()),c&&this.entities_[c]){var d=this.entities_[c].fromElement(a);return new b.Entity(c,d)}},a.prototype.tryRenderToElement_=function(a,c,d){var e=a.type,f=a.info;if(this.entities_[e]&&this.entities_[e][c]){var g=b.document||window&&window.document,h=this.entities_[e][c](f,d,g);if(h){if("string"==typeof h){var i=(b.document||document).createElement("div");return i.innerHTML=h,i.childNodes[0]}if("object"==typeof h)return b.utils.assert("undefined"!=typeof h.nodeType,"Error rendering "+e+" entity.  render() function must return an html string or a DOM element."),h}}},a.prototype.entitySupportsUpdate=function(a){return this.entities_[a]&&this.entities_[a].update},a}();var b=b||{};b.Entity=function(){function a(b,c){return this instanceof a?(this.type=b,void(this.info=c||{})):new a(b,c)}var c=b.AttributeConstants,d=c.ENTITY_SENTINEL,e=d+"_";return a.prototype.toAttributes=function(){var a={};a[d]=this.type;for(var b in this.info)a[e+b]=this.info[b];return a},a.fromAttributes=function(b){var c=b[d],f={};for(var g in b)0===g.indexOf(e)&&(f[g.substr(e.length)]=b[g]);return new a(c,f)},a}();var b=b||{};b.RichTextCodeMirror=function(){function c(a,b,c){this.codeMirror=a,this.options_=c||{},this.entityManager_=b,this.currentAttributes_=null,this.userId=c.userId,this.usersIds=c.usersIds;var d=this;this.annotationList_=new k(function(a,b){d.onAnnotationsChanged_(a,b)}),this.initAnnotationList_(),j(this,"onCodeMirrorBeforeChange_"),j(this,"onCodeMirrorChange_"),j(this,"onCursorActivity_"),CodeMirror=window.global.CodeMirror,parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}function d(a,b){return a.line-b.line||a.ch-b.ch}function e(a,b){return d(a,b)<=0}function f(a){return a[a.length-1]}function g(a){if(0===a.length)return 0;for(var b=0,c=0;c<a.length;c++)b+=a[c].length;return b+a.length-1}function h(a){this.attributes=a||{}}function i(a){for(var b in a)return!1;return!0}function j(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}var k=b.AnnotationList,l=b.Span,m=b.utils,n=b.AttributeConstants,o="cmrt-",p="cmrt-",q={c:"color",bc:"background-color",fs:"font-size",li:function(a){return"padding-left: "+40*a+"px"}},r={};m.makeEventEmitter(c,["change","attributesChange","newLine"]);var s=b.sentinelConstants.LINE_SENTINEL_CHARACTER,t=b.sentinelConstants.ENTITY_SENTINEL_CHARACTER;return c.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},c.prototype.toggleAttribute=function(a,b){var c=b||!0;if(this.emptySelection_()){var d=this.getCurrentAttributes_();d[a]===c?delete d[a]:d[a]=c,this.currentAttributes_=d}else{var e=this.getCurrentAttributes_(),f=e[a]!==c?c:!1;this.setAttribute(a,f)}},c.prototype.setAttribute=function(a,b){var c=this.codeMirror;if(this.emptySelection_()){var d=this.getCurrentAttributes_();b===!1?delete d[a]:d[a]=b,this.currentAttributes_=d}else this.updateTextAttributes(c.indexFromPos(c.getCursor("start")),c.indexFromPos(c.getCursor("end")),function(c){b===!1?delete c[a]:c[a]=b}),this.updateCurrentAttributes_()},c.prototype.updateTextAttributes=function(a,b,c,d,e){var f=[],g=a,j=this;this.annotationList_.updateSpan(new l(a,b-a),function(a,b){var k={};for(var l in a.attributes)k[l]=a.attributes[l];(!k[n.LINE_SENTINEL]||e)&&c(k);var m={},o={};return j.computeChangedAttributes_(a.attributes,k,m,o),i(m)||f.push({start:g,end:g+b,attributes:m,attributesInverse:o,origin:d}),g+=b,new h(k)}),f.length>0&&this.trigger("attributesChange",this,f)},c.prototype.computeChangedAttributes_=function(a,b,c,d){var e,f={};for(e in a)f[e]=!0;for(e in b)f[e]=!0;for(e in f)e in b?e in a?a[e]!==b[e]&&(c[e]=b[e],d[e]=a[e]):(c[e]=b[e],d[e]=!1):(c[e]=!1,d[e]=a[e])},c.prototype.toggleLineAttribute=function(a,b){var c,d=this.getCurrentLineAttributes_();c=a in d&&d[a]===b?!1:b,this.setLineAttribute(a,c)},c.prototype.setLineAttribute=function(a,b){this.updateLineAttributesForSelection(function(c){b===!1?delete c[a]:c[a]=b})},c.prototype.updateLineAttributesForSelection=function(a){var b=this.codeMirror,c=b.getCursor("start"),d=b.getCursor("end"),e=c.line,f=d.line,g=b.getLine(f),h=this.areLineSentinelCharacters_(g.substr(0,d.ch));f>e&&h&&f--,this.updateLineAttributes(e,f,a)},c.prototype.updateLineAttributes=function(a,b,c){for(var d=a;b>=d;d++){var e=this.codeMirror.getLine(d),f=this.codeMirror.indexFromPos({line:d,ch:0});if(e[0]!==s){var g={};g[n.LINE_SENTINEL]=!0,c(g),this.insertText(f,s,g)}else this.updateTextAttributes(f,f+1,c,null,!0)}},c.prototype.replaceText=function(a,b,c,d,e){this.changeId_++;var f=p+this.changeId_;this.outstandingChanges_[f]={origOrigin:e,attributes:d};var g=this.codeMirror,h=g.posFromIndex(a),i="number"==typeof b?g.posFromIndex(b):null;g.replaceRange(c,h,i,f)},c.prototype.insertText=function(a,b,c,d){var e=this.codeMirror,f=e.getCursor(),g="RTCMADAPTER"==d&&!e.somethingSelected()&&a==e.indexFromPos(f);this.replaceText(a,null,b,c,d),g&&e.setCursor(f)},c.prototype.removeText=function(a,b,c){var d=this.codeMirror;d.replaceRange("",d.posFromIndex(a),d.posFromIndex(b),c)},c.prototype.insertEntityAtCursor=function(a,b,c){var d=this.codeMirror,e=d.indexFromPos(d.getCursor("head"));this.insertEntityAt(e,a,b,c)},c.prototype.insertEntityAt=function(a,c,d,e){this.codeMirror;this.insertEntity_(a,new b.Entity(c,d),e)},c.prototype.insertEntity_=function(a,b,c){this.replaceText(a,null,t,b.toAttributes(),c)},c.prototype.getAttributeSpans=function(a,b){for(var c=[],d=this.annotationList_.getAnnotatedSpansForSpan(new l(a,b-a)),e=0;e<d.length;e++)c.push({length:d[e].length,attributes:d[e].annotation.attributes});return c},c.prototype.end=function(){var a=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:a,ch:this.codeMirror.getLine(a).length})},c.prototype.getRange=function(a,b){var c=this.codeMirror.posFromIndex(a),d=this.codeMirror.posFromIndex(b);return this.codeMirror.getRange(c,d)},c.prototype.initAnnotationList_=function(){var a=this.end();0!==a&&this.annotationList_.insertAnnotatedSpan(new l(0,a),new h)},c.prototype.onAnnotationsChanged_=function(a,b){var c,d={};this.tryToUpdateEntitiesInPlace(a,b);for(var e=0;e<a.length;e++){var f=a[e].annotation.attributes;n.LINE_SENTINEL in f&&(d[this.codeMirror.posFromIndex(a[e].pos).line]=!0),c=a[e].getAttachedObject(),c&&c.clear()}for(e=0;e<b.length;e++){var g=b[e].annotation,h=n.LINE_SENTINEL in g.attributes,i=n.ENTITY_SENTINEL in g.attributes,j=this.codeMirror.posFromIndex(b[e].pos);if(h)d[j.line]=!0;else if(i)this.markEntity_(b[e]);else{var k=this.getClassNameForAttributes_(g.attributes);if(""!==k){var l=this.codeMirror.posFromIndex(b[e].pos+b[e].length);c=this.codeMirror.markText(j,l,{className:k}),b[e].attachObject(c)}}}for(var m in d)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(m))),this.queueLineMarking_()},c.prototype.tryToUpdateEntitiesInPlace=function(a,b){for(var c=a.length;c--;)for(var d=a[c],e=b.length;e--;){var f=b[e];if(d.pos==f.pos&&d.length==f.length&&d.annotation.attributes.ent&&d.annotation.attributes.ent==f.annotation.attributes.ent){var g=f.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(g)){a.splice(c,1),b.splice(e,1);var h=d.getAttachedObject();h.update(f.annotation.attributes),f.attachObject(h)}}}},c.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var a=this;this.lineMarkTimeout_=setTimeout(function(){a.lineMarkTimeout_=null;for(var b=[],c=0;c<a.dirtyLines_.length;c++){var d=a.codeMirror.getLineNumber(a.dirtyLines_[c]);b.push(Number(d))}a.dirtyLines_=[],b.sort(function(a,b){return a-b});var e=-1;for(c=0;c<b.length;c++){var f=b[c];f>e&&(e=a.markLineSentinelCharactersForChangedLines_(f,f))}},0)}},c.prototype.addStyleWithCSS_=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css",c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.appendChild(c)},c.prototype.getClassNameForAttributes_=function(a){var c="";for(var d in a){var e=a[d];if(d===n.LINE_SENTINEL)b.utils.assert(e===!0,"LINE_SENTINEL attribute should be true if it exists.");else{var f=(this.options_.cssPrefix||o)+d;if(e!==!0){d===n.FONT_SIZE&&"string"!=typeof e&&(e+="px");var g=e.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(f+="-"+g,q[d]&&(r[d]||(r[d]={}),!r[d][g])){r[d][g]=!0;var h=q[d],i="function"==typeof h?h(e):h+": "+e,j=d==n.LINE_INDENT?"pre."+f:"."+f;this.addStyleWithCSS_(j+" { "+i+" }")}}c=c+" "+f}}return c},c.prototype.markEntity_=function(a){for(var c=a.annotation.attributes,d=b.Entity.fromAttributes(c),e=this.codeMirror,f=this,g=[],h=0;h<a.length;h++){var i=e.posFromIndex(a.pos+h),j=e.posFromIndex(a.pos+h+1),k={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},l=this.createEntityHandle_(d,a.pos),m=this.entityManager_.renderToElement(d,l);m&&(k.replacedWith=m);var n=e.markText(i,j,k);g.push(n),l.setMarker(n)}a.attachObject({clear:function(){for(var a=0;a<g.length;a++)g[a].clear()},update:function(a){for(var c=b.Entity.fromAttributes(a),d=0;d<g.length;d++)f.entityManager_.updateElement(c,g[d].replacedWith)}}),this.queueRefresh_()},c.prototype.queueRefresh_=function(){var a=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){a.codeMirror.refresh(),a.refreshTimer_=null},0))},c.prototype.createEntityHandle_=function(a,c){function d(){if(h){var a=h.find();return a?i.codeMirror.indexFromPos(a.from):null}return c}function e(){var a=d();null!=a&&(i.codeMirror.focus(),i.removeText(a,a+1))}function f(c){var e=b.AttributeConstants,f=e.ENTITY_SENTINEL,g=f+"_",h=d();i.updateTextAttributes(h,h+1,function(b){for(var d in b)delete b[d];b[f]=a.type;for(var e in c)b[g+e]=c[e]})}function g(a){h=a}var h=null,i=this;return{find:d,remove:e,replace:f,setMarker:g}},c.prototype.lineClassRemover_=function(a){var b=this.codeMirror,c=b.getLineHandle(a);return{clear:function(){b.removeLineClass(c,"text",".*")}}},c.prototype.emptySelection_=function(){var a=this.codeMirror.getCursor("start"),b=this.codeMirror.getCursor("end");return a.line===b.line&&a.ch===b.ch},c.prototype.onCodeMirrorBeforeChange_=function(a,b){if("+input"===b.origin||"paste"===b.origin){for(var c=[],d=0;d<b.text.length;d++){var e=b.text[d];e=e.replace(new RegExp("["+s+t+"]","g"),""),c.push(e)}b.update(b.from,b.to,c)}},c.prototype.onCodeMirrorChange_=function(a,b){if("object"==typeof b.from){for(var c=[];b;)c.push(b),b=b.next;b=c}for(var d=this.convertCoordinateSystemForChanges_(b),e=[],f=0;f<d.length;f++){var g=d[f],i=g.start,j=(g.end,g.text),k=g.removed,m=g.origin;if(k.length>0){for(var n=this.annotationList_.getAnnotatedSpansForSpan(new l(i,k.length)),o=0,p=0;p<n.length;p++){var q=n[p];e.push({start:i,end:i+q.length,removedAttributes:q.annotation.attributes,removed:k.substr(o,q.length),attributes:{},text:"",origin:g.origin}),o+=q.length}this.annotationList_.removeSpan(new l(i,k.length))}if(j.length>0){var r;"+input"===g.origin||"paste"===g.origin?r=this.parseAuthorAndReadAttribute():m in this.outstandingChanges_?(r=this.outstandingChanges_[m].attributes,m=this.outstandingChanges_[m].origOrigin,delete this.outstandingChanges_[m]):r={},this.annotationList_.insertAnnotatedSpan(new l(i,j.length),new h(r)),e.push({start:i,end:i,removedAttributes:{},removed:"",text:j,attributes:r,origin:m})}}this.markLineSentinelCharactersForChanges_(b),e.length>0&&this.trigger("change",this,e)},c.prototype.parseAuthorAndReadAttribute=function(){var a=this.currentAttributes_||{};return a.a=this.userId,this.usersIds.forEach(function(b){a[b]=a.a===b?"read":"unread"}),a},c.prototype.convertCoordinateSystemForChanges_=function(a){function b(a,b){return function(c){return e(c,b.from)?a(c):e(b.to,c)?a({line:c.line+b.text.length-1-(b.to.line-b.from.line),ch:b.to.line<c.line?c.ch:b.text.length<=1?c.ch-(b.to.ch-b.from.ch)+g(b.text):c.ch-b.to.ch+f(b.text).length})+g(b.removed)-g(b.text):b.from.line===c.line?a(b.from)+c.ch-b.from.ch:a(b.from)+g(b.removed.slice(0,c.line-b.from.line))+1+c.ch}}for(var c=this,d=function(a){return c.codeMirror.indexFromPos(a)},h=[],i=a.length-1;i>=0;i--){var j=a[i];d=b(d,j);var k=d(j.from),l=j.removed.join("\n"),m=j.text.join("\n");h.unshift({start:k,end:k+l.length,removed:l,text:m,origin:j.origin})}return h},c.prototype.markLineSentinelCharactersForChanges_=function(a){for(var b=Number.MAX_VALUE,c=-1,d=0;d<a.length;d++){var e=a[d],f=e.from.line;e.from.ch;(e.removed.length>1||e.removed[0].indexOf(s)>=0)&&(b=Math.min(b,f),c=Math.max(c,f)),e.text.length>1?(b=Math.min(b,f),c=Math.max(c,f+e.text.length-1)):e.text[0].indexOf(s)>=0&&(b=Math.min(b,f),c=Math.max(c,f))}c=Math.min(c,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(b,c)},c.prototype.markLineSentinelCharactersForChangedLines_=function(a,b){if(a<Number.MAX_VALUE)for(;a>0&&this.lineIsListItemOrIndented_(a-1);)a--;if(b>-1)for(var c=this.codeMirror.lineCount();c>b+1&&this.lineIsListItemOrIndented_(b+1);)b++;for(var d=[],e=this.codeMirror,f=a;b>=f;f++){var g=e.getLine(f),h=e.getLineHandle(f);if(e.removeLineClass(h,"text",".*"),g.length>0)for(var i=g.indexOf(s);i>=0;){for(var j=i;i<g.length&&g[i]===s;){for(var k=e.findMarksAt({line:f,ch:i}),l=0;l<k.length;l++)k[l].isForLineSentinel&&k[l].clear();i++}this.markLineSentinelCharacters_(f,j,i,d),i=g.indexOf(s,i)}else d=[]}return b},c.prototype.markLineSentinelCharacters_=function(a,b,c,d){var e=this.codeMirror,f=null,g=null,h=function(){var a=g.find();return a?a.from.line:null};if(0===b){var i=this.getLineAttributes_(a),j=i[n.LIST_TYPE],k=i[n.LINE_INDENT]||0;for(j&&0===k&&(k=1);k>=d.length;)d.push(1);"o"===j?(f=this.makeOrderedListElement_(d[k]),d[k]++):"u"===j?(f=this.makeUnorderedListElement_(),d[k]=1):"t"===j?(f=this.makeTodoListElement_(!1,h),d[k]=1):"tc"===j&&(f=this.makeTodoListElement_(!0,h),d[k]=1);var l=this.getClassNameForAttributes_(i);""!==l&&this.codeMirror.addLineClass(a,"text",l),d=d.slice(0,k+1)}var m={inclusiveLeft:!0,collapsed:!0};f&&(m.replacedWith=f);var g=e.markText({line:a,ch:b},{line:a,ch:c},m);g.isForLineSentinel=!0},c.prototype.makeOrderedListElement_=function(a){return m.elt("div",a+".",{"class":"firepad-list-left"})},c.prototype.makeUnorderedListElement_=function(){return m.elt("div","•",{"class":"firepad-list-left"})},c.prototype.toggleTodo=function(a){var b,c=n.LIST_TYPE,d=this.getCurrentLineAttributes_();c in d&&("t"===d[c]||"tc"===d[c])?"t"===d[c]?b="tc":"tc"===d[c]&&(b=a?"t":!1):b="t",this.setLineAttribute(c,b)},c.prototype.makeTodoListElement_=function(a,b){var c={type:"checkbox","class":"firepad-todo-left"};a&&(c.checked=!0);var d=m.elt("input",!1,c),e=this;return m.on(d,"click",m.stopEventAnd(function(a){e.codeMirror.setCursor({line:b(),ch:1}),e.toggleTodo(!0)})),d},c.prototype.lineIsListItemOrIndented_=function(a){
var b=this.getLineAttributes_(a);return(b[n.LIST_TYPE]||!1)!==!1||0!==(b[n.LINE_INDENT]||0)},c.prototype.onCursorActivity_=function(){var a=this;setTimeout(function(){a.updateCurrentAttributes_()},1)},c.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},c.prototype.updateCurrentAttributes_=function(){var c=this.codeMirror,d=c.indexFromPos(c.getCursor("anchor")),e=c.indexFromPos(c.getCursor("head")),f=e;if(d>e){for(;f<this.end();){var g=this.getRange(f,f+1);if("\n"!==g&&g!==s)break;f++}f<this.end()&&f++}else for(;f>0&&(g=this.getRange(f-1,f),"\n"===g||g===s);)f--;var h=this.annotationList_.getAnnotatedSpansForPos(f);this.currentAttributes_={};var i={};h.length>0&&!(n.LINE_SENTINEL in h[0].annotation.attributes)?i=h[0].annotation.attributes:h.length>1&&(b.utils.assert(!(n.LINE_SENTINEL in h[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),i=h[1].annotation.attributes);for(var j in i)"l"!==j&&"lt"!==j&&"li"!==j&&0!==j.indexOf(n.ENTITY_SENTINEL)&&(this.currentAttributes_[j]=i[j]);a(c)},c.prototype.getCurrentLineAttributes_=function(){var a=this.codeMirror,b=a.getCursor("anchor"),c=a.getCursor("head"),d=c.line;return 0===c.ch&&b.line<c.line&&d--,this.getLineAttributes_(d)},c.prototype.getLineAttributes_=function(a){var c={},d=this.codeMirror.getLine(a);if(d.length>0&&d[0]===s){var e=this.codeMirror.indexFromPos({line:a,ch:0}),f=this.annotationList_.getAnnotatedSpansForSpan(new l(e,1));b.utils.assert(1===f.length);for(var g in f[0].annotation.attributes)c[g]=f[0].annotation.attributes[g]}return c},c.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new l(0,this.end()),function(a,b){return new h({})})},c.prototype.newline=function(){var a=this.codeMirror,b=this;if(this.emptySelection_()){var c=a.getCursor("head").line,d=this.getLineAttributes_(c),e=d[n.LIST_TYPE];e&&1===a.getLine(c).length?this.updateLineAttributes(c,c,function(a){delete a[n.LIST_TYPE],delete a[n.LINE_INDENT]}):(a.replaceSelection("\n","end","+input"),this.updateLineAttributes(c+1,c+1,function(a){for(var f in d)a[f]=d[f];"tc"===e&&(a[n.LIST_TYPE]="t"),b.trigger("newLine",{line:c+1,attr:a})}))}else a.replaceSelection("\n","end","+input")},c.prototype.deleteLeft=function(){var a=this.codeMirror,b=a.getCursor("head"),c=this.getLineAttributes_(b.line),d=c[n.LIST_TYPE],e=c[n.LINE_INDENT],f=this.emptySelection_()&&1===b.ch;f&&d?this.updateLineAttributes(b.line,b.line,function(a){delete a[n.LIST_TYPE],delete a[n.LINE_INDENT]}):f&&e&&e>0?this.unindent():a.deleteH(-1,"char")},c.prototype.deleteRight=function(){var a=this.codeMirror,b=a.getCursor("head"),c=a.getLine(b.line),d=this.areLineSentinelCharacters_(c),e=b.line+1<a.lineCount()?a.getLine(b.line+1):"";this.emptySelection_()&&d&&e[0]===s?(a.replaceRange("",{line:b.line,ch:0},{line:b.line+1,ch:0},"+input"),a.setCursor({line:b.line,ch:0})):a.deleteH(1,"char")},c.prototype.indent=function(){this.updateLineAttributesForSelection(function(a){var b=a[n.LINE_INDENT],c=a[n.LIST_TYPE];b?a[n.LINE_INDENT]++:c?a[n.LINE_INDENT]=2:a[n.LINE_INDENT]=1})},c.prototype.unindent=function(){this.updateLineAttributesForSelection(function(a){var b=a[n.LINE_INDENT];b&&b>1?a[n.LINE_INDENT]=b-1:(delete a[n.LIST_TYPE],delete a[n.LINE_INDENT])})},c.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(s,"g"),"")},c.prototype.areLineSentinelCharacters_=function(a){for(var b=0;b<a.length;b++)if(a[b]!==s)return!1;return!0},h.prototype.equals=function(a){if(!(a instanceof h))return!1;var b;for(b in this.attributes)if(a.attributes[b]!==this.attributes[b])return!1;for(b in a.attributes)if(a.attributes[b]!==this.attributes[b])return!1;return!0},c}();var b=b||{};b.RichTextCodeMirrorAdapter=function(){"use strict";function a(a){this.rtcm=a,this.cm=a.codeMirror,g(this,"onChange"),g(this,"onAttributesChange"),g(this,"onCursorActivity"),g(this,"onFocus"),g(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function c(a,b){return a.line<b.line?-1:a.line>b.line?1:a.ch<b.ch?-1:a.ch>b.ch?1:0}function d(a,b){return 0===c(a,b)}function e(a){var b=a.lineCount()-1;return a.indexFromPos({line:b,ch:a.getLine(b).length})}function f(a,b){if(!a)throw new Error(b||"assertion error")}function g(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}function h(a){for(var b in a)return!1;return!0}function i(a,b){if("string"!=typeof a)throw new TypeError("Expected a string");a=a.replace(/^#/,""),3===a.length&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]);var c=parseInt(a,16),d=[c>>16,c>>8&255,255&c],e="rgb";return j(b)&&(e="rgba",d.push(b)),e+"("+d.join(",")+")"}function j(a){return null!==a&&void 0!==a}var k=b.TextOperation,l=b.WrappedOperation,m=b.Cursor;return a.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},a.operationFromCodeMirrorChanges=function(a,b){for(var c=e(b),d=(new k).retain(c),f=(new k).retain(c),g=a.length-1;g>=0;g--){var h=a[g],i=h.start,j=c-i-h.text.length;d=(new k).retain(i)["delete"](h.removed.length).insert(h.text,h.attributes).retain(j).compose(d),f=f.compose((new k).retain(i)["delete"](h.text.length).insert(h.removed,h.removedAttributes).retain(j)),c+=h.removed.length-h.text.length}return[d,f]},a.operationFromAttributesChanges=function(a,b){for(var c=e(b),d=new k,g=new k,h=0,i=0;i<a.length;i++){var j=a[i],l=j.start-h;f(l>=0),d.retain(l),g.retain(l);var m=j.end-j.start;d.retain(m,j.attributes),g.retain(m,j.attributesInverse),h=j.start+m}return d.retain(c-h),g.retain(c-h),[d,g]},a.prototype.registerCallbacks=function(a){this.callbacks=a},a.prototype.onChange=function(b,c){if("RTCMADAPTER"!==c[0].origin){var d=a.operationFromCodeMirrorChanges(c,this.cm);this.trigger("change",d[0],d[1])}},a.prototype.onAttributesChange=function(b,c){if("RTCMADAPTER"!==c[0].origin){var d=a.operationFromAttributesChanges(c,this.cm);this.trigger("change",d[0],d[1])}},a.prototype.onCursorActivity=function(){var a=this;setTimeout(function(){a.trigger("cursorActivity")},1)},a.prototype.onFocus=function(){this.trigger("focus")},a.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},a.prototype.getValue=function(){return this.cm.getValue()},a.prototype.getCursor=function(){var a,b=this.cm,c=b.getCursor(),e=b.indexFromPos(c);if(b.somethingSelected()){var f=b.getCursor(!0),g=d(c,f)?b.getCursor(!1):f;a=b.indexFromPos(g)}else a=e;return new m(e,a)},a.prototype.setCursor=function(a){this.cm.setSelection(this.cm.posFromIndex(a.position),this.cm.posFromIndex(a.selectionEnd))},a.prototype.addStyleRule=function(a){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var b=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(b),this.addedStyleSheet=b.sheet}if(!this.addedStyleRules[a])return this.addedStyleRules[a]=!0,this.addedStyleSheet.insertRule(a,0)}},a.prototype.setOtherCursor=function(a,b,c){var d=this.cm.posFromIndex(a.position);if("string"==typeof b&&b.match(/^#[a-fA-F0-9]{3,6}$/)){var e=this.rtcm.end();if("object"==typeof a&&"number"==typeof a.position&&"number"==typeof a.selectionEnd&&!(a.position<0||a.position>e||a.selectionEnd<0||a.selectionEnd>e)){if(a.position===a.selectionEnd){var f=this.cm.cursorCoords(d),g=document.createElement("span");return g.className="other-client",g.style.borderLeftWidth="2px",g.style.borderLeftStyle="solid",g.style.borderLeftColor=b,g.style.marginLeft=g.style.marginRight="-1px",g.style.height=.9*(f.bottom-f.top)+"px",g.setAttribute("data-clientid",c),g.style.zIndex=0,this.cm.setBookmark(d,{widget:g,insertLeft:!0})}var h="selection-"+b.replace("#",""),j=.4,k="."+h+" { background: "+i(b)+";\n background: "+i(b,j)+";}";this.addStyleRule(k);var l,m;return a.selectionEnd>a.position?(l=d,m=this.cm.posFromIndex(a.selectionEnd)):(l=this.cm.posFromIndex(a.selectionEnd),m=d),this.cm.markText(l,m,{className:h})}}},a.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},a.prototype.applyOperation=function(a){a.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var b=a.ops,c=0,d=0,e=b.length;e>d;d++){var f=b[d];f.isRetain()?(h(f.attributes)||this.rtcm.updateTextAttributes(c,c+f.chars,function(a){for(var b in f.attributes)f.attributes[b]===!1?delete a[b]:a[b]=f.attributes[b]},"RTCMADAPTER",!0),c+=f.chars):f.isInsert()?(this.rtcm.insertText(c,f.text,f.attributes,"RTCMADAPTER"),c+=f.text.length):f.isDelete()&&this.rtcm.removeText(c,c+f.chars,"RTCMADAPTER")}a.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},a.prototype.registerUndo=function(a){this.cm.undo=a},a.prototype.registerRedo=function(a){this.cm.redo=a},a.prototype.invertOperation=function(a){for(var b,c,d=0,e=this.rtcm.codeMirror,f=new k,g=0;g<a.wrapped.ops.length;g++){var i=a.wrapped.ops[g];if(i.isRetain())if(h(i.attributes))f.retain(i.chars),d+=i.chars;else for(b=this.rtcm.getAttributeSpans(d,d+i.chars),c=0;c<b.length;c++){var j={};for(var m in i.attributes){var n=i.attributes[m],o=b[c].attributes[m];n===!1?o&&(j[m]=o):n!==o&&(j[m]=o||!1)}f.retain(b[c].length,j),d+=b[c].length}else if(i.isInsert())f["delete"](i.text.length);else if(i.isDelete()){var p=e.getRange(e.posFromIndex(d),e.posFromIndex(d+i.chars));b=this.rtcm.getAttributeSpans(d,d+i.chars);var q=0;for(c=0;c<b.length;c++)f.insert(p.substr(q,b[c].length),b[c].attributes),q+=b[c].length;d+=i.chars}}return new l(f,a.meta.invert())},a}();var b=b||{};b.Formatting=function(){function a(b){return this instanceof a?void(this.attributes=b||{}):new a(b)}var c=b.AttributeConstants;return a.prototype.cloneWithNewAttribute_=function(b,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[b]:d[b]=c,new a(d)},a.prototype.bold=function(a){return this.cloneWithNewAttribute_(c.BOLD,a)},a.prototype.italic=function(a){return this.cloneWithNewAttribute_(c.ITALIC,a)},a.prototype.underline=function(a){return this.cloneWithNewAttribute_(c.UNDERLINE,a)},a.prototype.strike=function(a){return this.cloneWithNewAttribute_(c.STRIKE,a)},a.prototype.font=function(a){return this.cloneWithNewAttribute_(c.FONT,a)},a.prototype.fontSize=function(a){return this.cloneWithNewAttribute_(c.FONT_SIZE,a)},a.prototype.color=function(a){return this.cloneWithNewAttribute_(c.COLOR,a)},a.prototype.backgroundColor=function(a){return this.cloneWithNewAttribute_(c.BACKGROUND_COLOR,a)},a}();var b=b||{};b.Text=function(){function a(c,d){return this instanceof a?(this.text=c,void(this.formatting=d||b.Formatting())):new a(c,d)}return a}();var b=b||{};b.LineFormatting=function(){function a(b){return this instanceof a?(this.attributes=b||{},void(this.attributes[c.LINE_SENTINEL]=!0)):new a(b)}var c=b.AttributeConstants;return a.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},a.prototype.cloneWithNewAttribute_=function(b,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[b]:d[b]=c,new a(d)},a.prototype.indent=function(a){return this.cloneWithNewAttribute_(c.LINE_INDENT,a)},a.prototype.align=function(a){return this.cloneWithNewAttribute_(c.LINE_ALIGN,a)},a.prototype.listItem=function(a){return b.utils.assert(a===!1||"u"===a||"o"===a||"t"===a||"tc"===a),this.cloneWithNewAttribute_(c.LIST_TYPE,a)},a.prototype.getIndent=function(){return this.attributes[c.LINE_INDENT]||0},a.prototype.getAlign=function(){return this.attributes[c.LINE_ALIGN]||0},a.prototype.getListItem=function(){return this.attributes[c.LIST_TYPE]||!1},a}();var b=b||{};b.Line=function(){function a(c,d){return this instanceof a?("[object Array]"!==Object.prototype.toString.call(c)&&(c="undefined"==typeof c?[]:[c]),this.textPieces=c,void(this.formatting=d||b.LineFormatting())):new a(c,d)}return a}();var b=b||{};b.ParseHtml=function(){function a(a,c,d){this.listType=a||i.UNORDERED,this.lineFormatting=c||b.LineFormatting(),this.textFormatting=d||b.Formatting()}function c(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}function d(d,f){var g=(b.document||document).createElement("div");g.innerHTML=d,j=f;var h=new c,i=new a;return e(g,i,h),h.lines}function e(a,c,d){if(a.nodeType===k.ELEMENT_NODE){var e=j.fromElement(a);if(e)return void d.currentLine.push(new b.Text(b.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new b.Formatting(e.toAttributes())))}switch(a.nodeType){case k.TEXT_NODE:var l=a.nodeValue.replace(/[ \n\t]+/g," ");d.currentLine.push(b.Text(l,c.textFormatting));break;case k.ELEMENT_NODE:var m=a.getAttribute("style")||"";switch(c=h(c,m),a.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":d.newlineIfNonEmpty(c),f(a,c,d),d.newlineIfNonEmpty(c);break;case"center":c=c.withAlign("center"),d.newlineIfNonEmpty(c),f(a,c.withAlign("center"),d),d.newlineIfNonEmpty(c);break;case"b":case"strong":f(a,c.withTextFormatting(c.textFormatting.bold(!0)),d);break;case"u":f(a,c.withTextFormatting(c.textFormatting.underline(!0)),d);break;case"i":case"em":f(a,c.withTextFormatting(c.textFormatting.italic(!0)),d);break;case"s":f(a,c.withTextFormatting(c.textFormatting.strike(!0)),d);break;case"font":var n=a.getAttribute("face"),o=a.getAttribute("color"),p=parseInt(a.getAttribute("size"));n&&(c=c.withTextFormatting(c.textFormatting.font(n))),o&&(c=c.withTextFormatting(c.textFormatting.color(o))),p&&(c=c.withTextFormatting(c.textFormatting.fontSize(p))),f(a,c,d);break;case"br":d.newline(c);break;case"ul":d.newlineIfNonEmptyOrListItem(c);var q="firepad-todo"===a.getAttribute("class")?i.TODO:i.UNORDERED;f(a,c.withListType(q).withIncreasedIndent(),d),d.newlineIfNonEmpty(c);break;case"ol":d.newlineIfNonEmptyOrListItem(c),f(a,c.withListType(i.ORDERED).withIncreasedIndent(),d),d.newlineIfNonEmpty(c);break;case"li":g(a,c,d);break;case"style":break;default:f(a,c,d)}}}function f(a,b,c){if(a.hasChildNodes())for(var d=0;d<a.childNodes.length;d++)e(a.childNodes[d],b,c)}function g(a,b,c){c.newlineIfNonEmptyOrListItem(b);var d="firepad-checked"===a.getAttribute("class")?i.TODOCHECKED:b.listType;c.makeListItem(d);var e=c.currentLine;f(a,b,c),(e===c.currentLine||c.currentLine.length>0)&&c.newline(b)}function h(a,c){for(var d=a.textFormatting,e=a.lineFormatting,f=c.split(";"),g=0;g<f.length;g++){var h=f[g].split(":");if(2===h.length){var i=b.utils.trim(h[0]).toLowerCase(),j=b.utils.trim(h[1]).toLowerCase();switch(i){case"text-decoration":var k=j.indexOf("underline")>=0,l=j.indexOf("line-through")>=0;d=d.underline(k).strike(l);break;case"font-weight":var m="bold"===j||parseInt(j)>=600;d=d.bold(m);break;case"font-style":var n="italic"===j||"oblique"===j;d=d.italic(n);break;case"color":d=d.color(j);break;case"background-color":d=d.backgroundColor(j);break;case"text-align":e=e.align(j);break;case"font-size":var o=null,p=["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"];b.utils.stringEndsWith(j,p)?o=j:parseInt(j)&&(o=parseInt(j)+"px"),o&&(d=d.fontSize(o));break;case"font-family":var q=b.utils.trim(j.split(",")[0]);q=q.replace(/['"]/g,""),q=q.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),d=d.font(q)}}}return a.withLineFormatting(e).withTextFormatting(d)}var i=b.LineFormatting.LIST_TYPE;a.prototype.withTextFormatting=function(b){return new a(this.listType,this.lineFormatting,b)},a.prototype.withLineFormatting=function(b){return new a(this.listType,b,this.textFormatting)},a.prototype.withListType=function(b){return new a(b,this.lineFormatting,this.textFormatting)},a.prototype.withIncreasedIndent=function(){var b=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new a(this.listType,b,this.textFormatting)},a.prototype.withAlign=function(b){var c=this.lineFormatting.align(b);return new a(this.listType,c,this.textFormatting)},c.prototype.newlineIfNonEmpty=function(a){this.cleanLine_(),this.currentLine.length>0&&this.newline(a)},c.prototype.newlineIfNonEmptyOrListItem=function(a){this.cleanLine_(),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(a)},c.prototype.newline=function(a){this.cleanLine_();var c=a.lineFormatting;null!==this.currentLineListItemType&&(c=c.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(b.Line(this.currentLine,c)),this.currentLine=[]},c.prototype.makeListItem=function(a){this.currentLineListItemType=a},c.prototype.cleanLine_=function(){if(this.currentLine.length>0){var a=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[a].text=this.currentLine[a].text.replace(/ +$/g,"");for(var b=0;b<this.currentLine.length;b++)this.currentLine[b].text=this.currentLine[b].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var j,k=k||{ELEMENT_NODE:1,TEXT_NODE:3};return d}();var b=b||{};b.SerializeHtml=function(){function a(a){return a===i.ORDERED?"<ol>":a===i.UNORDERED?"<ul>":'<ul class="firepad-todo">'}function c(a){return a===i.ORDERED?"</ol>":"</ul>"}function d(a,b){return a===b||a===i.TODO&&b===i.TODOCHECKED||a===i.TODOCHECKED&&b===i.TODO}function e(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")}function f(f,k){for(var l="",m=!0,n=[],o=!1,p=!0,q=!0,r=0,s=f.ops[r],t=!1;s;){g.assert(s.isInsert());var u=s.attributes;if(m){m=!1;var v=0,w=null,x="left";h.LINE_SENTINEL in u&&(v=u[h.LINE_INDENT]||0,w=u[h.LIST_TYPE]||null,x=u[h.LINE_ALIGN]||"left"),w&&(v=v||1),o?(l+="</li>",o=!1):p||(q&&(l+="<br/>"),l+="</div>"),p=!1,g.assert(v>=0,"Indent must not be negative.");for(;n.length>v||v===n.length&&null!==w&&!d(w,n[n.length-1]);)l+=c(n.pop());for(;n.length<v;){var y=w||i.UNORDERED;t=w==i.TODO||w==i.TODOCHECKED||t,l+=a(y),n.push(y)}var z="left"!==x?' style="text-align:'+x+'"':"";if(w){var A="";switch(w){case i.TODOCHECKED:A=' class="firepad-checked"';break;case i.TODO:A=' class="firepad-unchecked"'}l+="<li"+A+z+">",o=!0}else l+="<div"+z+">";q=!0}if(h.LINE_SENTINEL in u)s=f.ops[++r];else if(h.ENTITY_SENTINEL in u){for(var B=0;B<s.text.length;B++){var C=b.Entity.fromAttributes(u),D=k.exportToElement(C);l+=D.outerHTML}s=f.ops[++r]}else{var E="",F="";for(var G in u){var H,I,J=u[G];G===h.BOLD||G===h.ITALIC||G===h.UNDERLINE||G===h.STRIKE?(g.assert(J===!0),H=I=G):G===h.FONT_SIZE?(H='span style="font-size: '+J,H+="string"!=typeof J||-1===J.indexOf("px",J.length-2)?'px"':'"',I="span"):G===h.FONT?(H='span style="font-family: '+J+'"',I="span"):G===h.COLOR?(H='span style="color: '+J+'"',I="span"):G===h.BACKGROUND_COLOR?(H='span style="background-color: '+J+'"',I="span"):g.log(!1,"Encountered unknown attribute while rendering html: "+G),H&&(E+="<"+H+">"),I&&(F="</"+I+">"+F)}var K=s.text,L=K.indexOf("\n");L>=0?(m=!0,s=L<K.length-1?new b.TextOp("insert",K.substr(L+1),u):f.ops[++r],K=K.substr(0,L)):s=f.ops[++r],K=K.replace(/  +/g,function(a){return new Array(a.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," "),K.length>0&&(q=!1),l+=E+e(K)+F}}for(o?l+="</li>":p||(q&&(l+="&nbsp;"),l+="</div>");n.length>0;)l+=c(n.pop());return t&&(l=j+l),l}var g=b.utils,h=b.AttributeConstants,i=b.LineFormatting.LIST_TYPE,j='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n';return f}();var b=b||{};b.textPiecesToInserts=function(a,c){function d(c,d){c instanceof b.Text&&(d=c.formatting.attributes,c=c.text),f.push({string:c,attributes:d}),a="\n"===c[c.length-1]}function e(c,e){a&&d(b.sentinelConstants.LINE_SENTINEL_CHARACTER,c.formatting.attributes);for(var f=0;f<c.textPieces.length;f++)d(c.textPieces[f]);e&&d("\n")}for(var f=[],g=0;g<c.length;g++)c[g]instanceof b.Line?e(c[g],g<c.length-1):d(c[g]);return f};var b=b||{};b.Headless=function(){function a(b){if(!(this instanceof a))return new a(b);var c,f;"string"==typeof b?(void 0===window.firebase&&"object"!=typeof c?(console.log("REQUIRING"),c=require("firebase")):c=window.firebase,f=c.database().refFromURL(b)):f=b,this.entityManager_=new e,this.firebaseAdapter_=new d(f),this.ready_=!1,this.zombie_=!1}var c=b.TextOperation,d=b.FirebaseAdapter,e=b.EntityManager,f=b.ParseHtml;return a.prototype.getDocument=function(a){var b=this;return b.ready_?a(b.firebaseAdapter_.getDocument()):void b.firebaseAdapter_.on("ready",function(){b.ready_=!0,a(b.firebaseAdapter_.getDocument())})},a.prototype.getText=function(a){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument(function(c){var d=c.apply("");for(key in b.sentinelConstants)d=d.replace(new RegExp(b.sentinelConstants[key],"g"),"");a(d)})},a.prototype.setText=function(a,b){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var d=c().insert(a);this.sendOperationWithRetry(d,b)},a.prototype.initializeFakeDom=function(a){"object"==typeof document||"object"==typeof b.document?a():require("jsdom").env("<head></head><body></body>",function(c,d){return b.document?(d.close(),a()):(b.document=d.document,void a())})},a.prototype.getHtml=function(a){var c=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");c.initializeFakeDom(function(){c.getDocument(function(d){a(b.SerializeHtml(d,c.entityManager_))})})},a.prototype.setHtml=function(a,d){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");e.initializeFakeDom(function(){for(var g=f(a,e.entityManager_),h=b.textPiecesToInserts(!0,g),i=new c,j=0;j<h.length;j++)i.insert(h[j].string,h[j].attributes);e.sendOperationWithRetry(i,d)})},a.prototype.sendOperationWithRetry=function(a,b){var c=this;c.getDocument(function(d){var e=a.clone()["delete"](d.targetLength);c.firebaseAdapter_.sendOperation(e,function(d,e){e?"undefined"!=typeof b&&b(null,e):c.sendOperationWithRetry(a,b)})})},a.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},a}();var b=b||{};return b.Firepad=function(a){function c(b,e,f){if(!(this instanceof c))return new c(b,e,f);if(q=window.global.CodeMirror,!q&&!r&&!a.monaco)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,q&&e instanceof q){this.codeMirror_=this.editor_=e;var i=this.codeMirror_.getValue();if(""!==i)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(r&&e&&e.session instanceof r.EditSession){if(this.ace_=this.editor_=e,i=this.ace_.getValue(),""!==i)throw new Error("Can't initialize Firepad with an ACE instance that already contains text.")}else if(a.monaco&&e&&e instanceof a.monaco.constructor){if(s=a.monaco,this.monaco_=this.editor_=e,i=this.monaco_.getValue(),""!==i)throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new q(e);var o;o=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_?this.ace_.container:this.monaco_.getDomNode(),this.firepadWrapper_=p.elt("div",null,{"class":"firepad"}),o.parentNode.replaceChild(this.firepadWrapper_,o),this.firepadWrapper_.appendChild(o),p.on(o,"dragstart",p.stopEvent),this.editor_.firepad=this,this.options_=f||{},this.getOption("richTextShortcuts",!1)&&(q.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.codeMirror_&&this.codeMirror_.refresh();var t=this.getOption("userId",b.push().key),u=this.getOption("userColor",d(t));if(this.entityManager_=new n,this.firebaseAdapter_=new l(b,t,u),this.codeMirror_){var v={userId:f.userId,cssPrefix:"firepad-",usersIds:f.usersIds};this.richTextCodeMirror_=new h(this.codeMirror_,this.entityManager_,v),this.editorAdapter_=new g(this.richTextCodeMirror_)}else this.ace_?this.editorAdapter_=new j(this.ace_):this.editorAdapter_=new k(this.monaco_);this.client_=new m(this.firebaseAdapter_,this.editorAdapter_);var w=this;this.firebaseAdapter_.on("cursor",function(){w.trigger.apply(w,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){w.trigger.apply(w,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){w.ready_=!0,this.ace_&&this.editorAdapter_.grabDocumentState(),this.monaco_&&this.editorAdapter_.grabDocumentState();var a=w.getOption("defaultText",null);a&&w.isHistoryEmpty()&&w.setText(a),w.trigger("ready")}),this.client_.on("synced",function(a){w.trigger("synced",a)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var a=document.getElementsByTagName("head")[0],b=document.createElement("style");b.type="text/css",b.styleSheet.cssText=":before,:after{content:none !important;}",a.appendChild(b),setTimeout(function(){a.removeChild(b)},0)})}function d(a){for(var b=1,c=0;c<a.length;c++)b=17*(b+a.charCodeAt(c))%360;var d=b/360;return f(d,1,.75)}function e(a,b,c){function d(a){var b=Math.round(255*a).toString(16);return 1===b.length?"0"+b:b}return"#"+d(a)+d(b)+d(c)}function f(a,b,c){if(0===b)return e(c,c,c);var d=.5>c?c*(1+b):c+b-b*c,f=2*c-d,g=function(a){return 0>a&&(a+=1),a>1&&(a-=1),1>6*a?f+6*(d-f)*a:1>2*a?d:2>3*a?f+6*(d-f)*(2/3-a):f};return e(g(a+1/3),g(a),g(a-1/3))}if(!b.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var g=b.RichTextCodeMirrorAdapter,h=b.RichTextCodeMirror,i=b.RichTextToolbar,j=b.ACEAdapter,k=b.MonacoAdapter,l=b.FirebaseAdapter,m=b.EditorClient,n=b.EntityManager,o=b.AttributeConstants,p=b.utils,q=(b.LineFormatting.LIST_TYPE,{}),r=a.ace,s=a.monaco;return p.makeEventEmitter(c),c.fromCodeMirror=c,c.fromACE=c,c.fromMonaco=c,c.prototype.dispose=function(){this.zombie_=!0,this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),this.firepadWrapper_.removeChild(editorWrapper),this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_),this.editor_.firepad=null,this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},c.prototype.setUserId=function(a){this.firebaseAdapter_.setUserId(a)},c.prototype.setUserColor=function(a){this.firebaseAdapter_.setColor(a)},c.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.ace_?this.ace_.getSession().getDocument().getValue():this.monaco_.getModel().getValue()},c.prototype.setText=function(a){return this.assertReady_("setText"),this.monaco_?this.monaco_.getModel().setValue(a):this.ace_?this.ace_.getSession().getDocument().setValue(a):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,a),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),void this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},c.prototype.insertTextAtCursor=function(a){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),a)},c.prototype.insertText=function(a,c){p.assert(!this.ace_,"Not supported for ace yet."),p.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(c)&&(c=[c]);var d=this;d.codeMirror_.operation(function(){for(var e=0===a,f=b.textPiecesToInserts(e,c),g=0;g<f.length;g++){var h=f[g].string,i=f[g].attributes;d.richTextCodeMirror_.insertText(a,h,i),a+=h.length}})},c.prototype.getOperationForSpan=function(a,c){for(var d=this.richTextCodeMirror_.getRange(a,c),e=this.richTextCodeMirror_.getAttributeSpans(a,c),f=0,g=new b.TextOperation,h=0;h<e.length;h++)g.insert(d.substr(f,e[h].length),e[h].attributes),f+=e[h].length;return g},c.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},c.prototype.getHtmlFromSelection=function(){var a=this.codeMirror_.getCursor("start"),b=this.codeMirror_.getCursor("end"),c=this.codeMirror_.indexFromPos(a),d=this.codeMirror_.indexFromPos(b);return this.getHtmlFromRange(c,d)},c.prototype.getHtmlFromRange=function(a,c){this.assertReady_("getHtmlFromRange");var d=null!=a&&null!=c?this.getOperationForSpan(a,c):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return b.SerializeHtml(d,this.entityManager_)},c.prototype.insertHtml=function(a,c){var d=b.ParseHtml(c,this.entityManager_);this.insertText(a,d)},c.prototype.insertHtmlAtCursor=function(a){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),a)},c.prototype.setHtml=function(a){var c=b.ParseHtml(a,this.entityManager_);this.setText(c)},c.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},c.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(o.BOLD),this.codeMirror_.focus()},c.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(o.ITALIC),this.codeMirror_.focus()},c.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(o.UNDERLINE),this.codeMirror_.focus()},c.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(o.STRIKE),this.codeMirror_.focus()},c.prototype.fontSize=function(a){this.richTextCodeMirror_.setAttribute(o.FONT_SIZE,a),this.codeMirror_.focus()},c.prototype.font=function(a){this.richTextCodeMirror_.setAttribute(o.FONT,a),this.codeMirror_.focus()},c.prototype.color=function(a){this.richTextCodeMirror_.setAttribute(o.COLOR,a),this.codeMirror_.focus()},c.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(o.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},c.prototype.align=function(a){if("left"!==a&&"center"!==a&&"right"!==a)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(o.LINE_ALIGN,a),this.codeMirror_.focus()},c.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(o.LIST_TYPE,"o"),this.codeMirror_.focus()},c.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(o.LIST_TYPE,"u"),this.codeMirror_.focus()},c.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},c.prototype.newline=function(){this.richTextCodeMirror_.newline()},c.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},c.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},c.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},c.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},c.prototype.undo=function(){this.codeMirror_.undo()},c.prototype.redo=function(){this.codeMirror_.redo()},c.prototype.insertEntity=function(a,b,c){console.log("insertEntity",a,b,c),this.richTextCodeMirror_.insertEntityAtCursor(a,b,c);
},c.prototype.insertEntityAt=function(a,b,c,d){console.log("insertEntityAt",a,b,c,d),this.richTextCodeMirror_.insertEntityAt(a,b,c,d)},c.prototype.registerEntity=function(a,b){this.entityManager_.register(a,b)},c.prototype.getOption=function(a,b){return a in this.options_?this.options_[a]:b},c.prototype.assertReady_=function(a){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+a+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+a+"]")},c.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},c.prototype.makeDialog_=function(a,b){var c=this,d=function(){var a=document.getElementById("overlay");a.style.visibility="hidden",c.firepadWrapper_.removeChild(a)},e=function(){var b=document.getElementById("overlay");b.style.visibility="hidden";var d=document.getElementById(a).value;null!==d&&c.insertEntity(a,{src:d}),c.firepadWrapper_.removeChild(b)},f=p.elt("input",null,{"class":"firepad-dialog-input",id:a,type:"text",placeholder:b,autofocus:"autofocus"}),g=p.elt("a","Submit",{"class":"waves-effect waves-light btn",id:"submitbtn"});p.on(g,"click",p.stopEventAnd(e));var h=p.elt("a","Cancel",{"class":"waves-effect waves-light btn"});p.on(h,"click",p.stopEventAnd(d));var i=p.elt("div",[g,h],{"class":"firepad-btn-group"}),j=p.elt("div",[f,i],{"class":"firepad-dialog-div"}),k=p.elt("div",[j],{"class":"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(k)},c.prototype.addToolbar_=function(){this.toolbar=new i(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},c.prototype.addPoweredByLogo_=function(){var a=p.elt("a",null,{"class":"powered-by-firepad"});a.setAttribute("href","http://www.firepad.io/"),a.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(a)},c.prototype.initializeKeyMap_=function(){function a(a){return function(b){setTimeout(function(){a.call(b.firepad)},0)}}q.keyMap.richtext={"Ctrl-B":a(this.bold),"Cmd-B":a(this.bold),"Ctrl-I":a(this.italic),"Cmd-I":a(this.italic),"Ctrl-U":a(this.underline),"Cmd-U":a(this.underline),"Ctrl-H":a(this.highlight),"Cmd-H":a(this.highlight),Enter:a(this.newline),Delete:a(this.deleteRight),Backspace:a(this.deleteLeft),Tab:a(this.indent),"Shift-Tab":a(this.unindent),fallthrough:["default"]}},c}(this),b.Firepad.Formatting=b.Formatting,b.Firepad.Text=b.Text,b.Firepad.Entity=b.Entity,b.Firepad.LineFormatting=b.LineFormatting,b.Firepad.Line=b.Line,b.Firepad.TextOperation=b.TextOperation,b.Firepad.Headless=b.Headless,b.Firepad.RichTextCodeMirrorAdapter=b.RichTextCodeMirrorAdapter,b.Firepad.ACEAdapter=b.ACEAdapter,b.Firepad.MonacoAdapter=b.MonacoAdapter,b.Firepad},this);